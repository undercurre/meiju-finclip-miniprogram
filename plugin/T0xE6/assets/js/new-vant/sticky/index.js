import{getRect}from"../common/utils";import{VantComponent}from"../common/component";import{isDef}from"../common/validator";import{pageScrollMixin}from"../mixins/page-scroll";const ROOT_ELEMENT=".van-sticky";VantComponent({props:{zIndex:{type:Number,value:99},offsetTop:{type:Number,value:0,observer:"onScroll"},disabled:{type:Boolean,observer:"onScroll"},container:{type:null,observer:"onScroll"},scrollTop:{type:null,observer(val){this.onScroll({scrollTop:val})}}},mixins:[pageScrollMixin(function(event){this.data.scrollTop==null&&this.onScroll(event)})],data:{height:0,fixed:!1,transform:0},mounted(){this.onScroll()},methods:{onScroll({scrollTop}={}){const{container,offsetTop,disabled}=this.data;if(disabled){this.setDataAfterDiff({fixed:!1,transform:0});return}if(this.scrollTop=scrollTop||this.scrollTop,typeof container=="function"){Promise.all([getRect(this,ROOT_ELEMENT),this.getContainerRect()]).then(([root,container2])=>{offsetTop+root.height>container2.height+container2.top?this.setDataAfterDiff({fixed:!1,transform:container2.height-root.height}):offsetTop>=root.top?this.setDataAfterDiff({fixed:!0,height:root.height,transform:0}):this.setDataAfterDiff({fixed:!1,transform:0})});return}getRect(this,ROOT_ELEMENT).then(root=>{!isDef(root)||(offsetTop>=root.top?(this.setDataAfterDiff({fixed:!0,height:root.height}),this.transform=0):this.setDataAfterDiff({fixed:!1}))})},setDataAfterDiff(data){wx.nextTick(()=>{const diff=Object.keys(data).reduce((prev,key)=>(data[key]!==this.data[key]&&(prev[key]=data[key]),prev),{});Object.keys(diff).length>0&&this.setData(diff),this.$emit("scroll",{scrollTop:this.scrollTop,isFixed:data.fixed||this.data.fixed})})},getContainerRect(){const nodesRef=this.data.container();return new Promise(resolve=>nodesRef.boundingClientRect(resolve).exec())}}});
