"use strict";function e(t){return e="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},e(t)}function t(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function n(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}function i(e,t,i){return t&&n(e.prototype,t),i&&n(e,i),Object.defineProperty(e,"prototype",{writable:!1}),e}function r(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function o(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),Object.defineProperty(e,"prototype",{writable:!1}),t&&s(e,t)}function a(e){return a=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)},a(e)}function s(e,t){return s=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e},s(e,t)}function u(e,t){if(t&&("object"==typeof t||"function"==typeof t))return t;if(void 0!==t)throw new TypeError("Derived constructors may only return object or undefined");return function(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}(e)}function c(e){var t=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(e){return!1}}();return function(){var n,i=a(e);if(t){var r=a(this).constructor;n=Reflect.construct(i,arguments,r)}else n=i.apply(this,arguments);return u(this,n)}}function f(e,t){for(;!Object.prototype.hasOwnProperty.call(e,t)&&null!==(e=a(e)););return e}function h(){return h="undefined"!=typeof Reflect&&Reflect.get?Reflect.get:function(e,t,n){var i=f(e,t);if(!i)return;var r=Object.getOwnPropertyDescriptor(i,t);if(r.get)return r.get.call(arguments.length<3?e:n);return r.value},h.apply(this,arguments)}function p(e,t){return function(e){if(Array.isArray(e))return e}(e)||function(e,t){var n=null==e?null:"undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(null==n)return;var i,r,o=[],a=!0,s=!1;try{for(n=n.call(e);!(a=(i=n.next()).done)&&(o.push(i.value),!t||o.length!==t);a=!0);}catch(e){s=!0,r=e}finally{try{a||null==n.return||n.return()}finally{if(s)throw r}}return o}(e,t)||d(e,t)||function(){throw new TypeError("Invalid attempt to destructure non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()}function l(e){return function(e){if(Array.isArray(e))return _(e)}(e)||function(e){if("undefined"!=typeof Symbol&&null!=e[Symbol.iterator]||null!=e["@@iterator"])return Array.from(e)}(e)||d(e)||function(){throw new TypeError("Invalid attempt to spread non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()}function d(e,t){if(!e)return;if("string"==typeof e)return _(e,t);var n=Object.prototype.toString.call(e).slice(8,-1);if("Object"===n&&e.constructor&&(n=e.constructor.name),"Map"===n||"Set"===n)return Array.from(e);if("Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n))return _(e,t)}function _(e,t){(null==t||t>e.length)&&(t=e.length);for(var n=0,i=new Array(t);n<t;n++)i[n]=e[n];return i}var v=function(){function e(n){t(this,e),this.enable=!0,this.console=n}return i(e,[{key:"setEnable",value:function(e){this.enable=e}},{key:"info",value:function(){var e;this.enable&&(e=this.console).log.apply(e,arguments)}},{key:"warn",value:function(){var e;this.enable&&(e=this.console).warn.apply(e,arguments)}},{key:"error",value:function(){var e;this.enable&&(e=this.console).error.apply(e,arguments)}}]),e}(),y=function(){return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,(function(e){var t=16*Math.random()|0;return("x"===e?t:3&t|8).toString(16)}))},g=function(e){var t=e;try{t=decodeURIComponent(e)}catch(e){}return t},m=function(e,t){var n=e;if(t){var i=[];Object.keys(t).forEach((function(e){i.push("".concat(e,"=").concat(t[e]))})),i.length>0&&(n+="?".concat(i.join("&")))}return n},k=function(e){var t={};return e&&e.split("&").forEach((function(e){if(e){var n=e.split("=");n[0]&&(t[n[0]]=n[1]||"")}})),t},b=function(){return+new Date},O=function(e){return null!=e&&"[object Object]"==Object.prototype.toString.call(e)};function w(e){for(var t=0,n=0,i=(e+="").length,r=0;r<i;r++)((t=31*t+e.charCodeAt(n++))>0x7fffffffffff||t<-0x800000000000)&&(t&=0xffffffffffff);return t<0&&(t+=0x7ffffffffffff),t}var x,E=void 0,S={"Content-Type":"application/json"};x={cn:"https://mcs.ctobsnssdk.com",va:"https://mcs.itobsnssdk.com",sg:"https://mcs.tobsnssdk.com"},"/v2/user/webid","/v2/user/ssid","/v2/event/list";var j,I={cn:"https://dpprofile.snssdk.com",sg:"https://sgali-dpprofile.byteoversea.com",va:"https://vaali-dpprofile.byteoversea.com"};!function(e){e.Init="init",e.Instantiation="instantiation",e.AutoReport="auto-report",e.AbTest="ab-test",e.FetchWhite="fetch-white",e.Device="device",e.Config="config",e.StopReport="stop-report",e.FetchSsid="fetch-ssid",e.Send="send",e.TokenOk="token-ok",e.StartReport="start-report",e.FetchSsidComplete="fetch-ssid-complete",e.FetchSsidCompleteDone="fetch-ssid-complete-done",e.ProfileClear="profile-clear",e.FetchTokenComplete="fetch-token-complete",e.FetchWebidComplete="fetch-webid-complete",e.FetchWebid="fetch-webid",e.FetchToken="fetch-token",e.FetchWhiteComplete="fetch-white-complete",e.BeforeMerge="before-merge",e.BeforeConfig="before-config",e.Verify="verify",e.ImmediateReportBatch="immediate-report-batch",e.ImmediateReport="immediate-report",e.Event="event",e.Profile="profile",e.ProfileOnce="profile-once",e.AbVar="ab-var",e.AbAllvars="ab-allvars",e.ProfileSet="profile-set",e.ProfileSetOnce="profile-set-once",e.ProfileUnset="profile-unset",e.ProfileIncrement="profile-increment",e.ProfileAppend="profile-append",e.FetchSsidCompleteHook="fetch-ssid-complete-hook",e.VerifyDomain="verify-domain",e.VerifyOpen="verify-open",e.IntervalReport="interval-report",e.Report="report",e.ProfileInfo="profile-info",e.ReportOption="report-option",e.ReportComplete="report-complete",e.BatchReportComplete="batch-report-complete",e.VerifyClose="verify-close",e.AbExposure="ab-exposure",e.FilterCrawler="filter-crawler",e.ClearStorage="clear-storage",e.ReportBefore="report-before",e.ReportAfter="report-after",e.AppShow="app-show",e.AppHide="app-hide",e.PageShow="page-show",e.PageHide="page-hide",e.AbVersionChange="ab-version-change",e.NotAutoReport="not-auto-report",e.ExternalAbVersion="external-ab-version",e.CustomProcess="custom-process",e.LaunchOk="launch-ok",e.TryReport="try-report",e.AbRefresh="ab-refresh"}(j||(j={}));var P,q={TransformInfo:"$transform-info",ExtendAppLaunch:"$extend-app-launch",ExtendAppTerminate:"$extend-app-terminate",ExtendAppError:"$extend-app-error",ExtendPageShow:"$extend-page-show",ExtendPageHide:"$extend-page-hide",ExtendPageShare:"$extend-page-share",ExtendPageFavorite:"$extend-page-favorite"},A={appOnShow:"app_launch",appOnHide:"app_terminate",appOnError:"on_error",pageOnShow:"predefine_pageview",pageOnHide:"predefine_pageview_hide",pageOnShareAppMessage:"on_share",pageOnAddToFavorites:"on_addtofavorites"},T=["utm_source","utm_medium","utm_campaign","utm_term","utm_content"],C="iscrawler";!function(e){e.True="true",e.False="false"}(P||(P={}));var D=["__profile_set","__profile_set_once","__profile_increment","__profile_unset","__profile_append"],U="applog_trace",N=(void 0,function(e,t){var n={};for(var i in e)Object.prototype.hasOwnProperty.call(e,i)&&t.indexOf(i)<0&&(n[i]=e[i]);if(null!=e&&"function"==typeof Object.getOwnPropertySymbols){var r=0;for(i=Object.getOwnPropertySymbols(e);r<i.length;r++)t.indexOf(i[r])<0&&Object.prototype.propertyIsEnumerable.call(e,i[r])&&(n[i[r]]=e[i[r]])}return n}),R=function(){function e(){t(this,e),this._pluginInstances=[],this.types=q,this.SdkHook=q,this._listeners={},this._pluginInstances=[],this._keyPrefix="__tea_cache_",this._inited=!1,this._sended=!1,this._tokenOK=!1,this._whiteOK=!1,this._verifyStatus=!1,this._options={report_domain:1,report_channel:"cn",report_interval:5e3,max_batch_event:5,max_storage_num:-1,auto_report:false,auto_profile:false,profile_channel:"cn",disable_storage:true,enable_storage:false,enable_ab_test:false,channel_domain:"",enable_et_test:false,enable_filter_list:false,report_url:"",enable_profile:false,ab_channel_domain:"",enable_filter_crawler:false,event_verify_url:"",enable_compatible_old:true,enable_custom_webid:false,request_timeout:-1,clear_ab_cache_on_user_change:true},this._envInfo={user:{web_id:E,ssid:E,user_unique_id:E,user_id:E,user_type:E,user_is_auth:E,user_is_login:E,ip_addr_id:E,device_id:E},header:{app_id:E,app_name:E,app_install_id:E,install_id:E,app_package:E,app_channel:E,app_version:E,os_name:E,os_version:E,device_model:E,device_brand:E,traffic_type:E,client_ip:E,os_api:E,access:E,language:E,app_language:E,creative_id:E,ad_id:E,campaign_id:E,ab_client:E,ab_version:E,platform:E,sdk_version:E,sdk_lib:E,app_region:E,region:E,province:E,city:E,timezone:E,tz_offset:E,tz_name:E,sim_region:E,carrier:E,resolution:E,screen_width:E,screen_height:E,browser:E,browser_version:E,referrer:E,referrer_host:E,utm_source:E,utm_medium:E,utm_campaign:E,utm_term:E,utm_content:E,custom:{},ab_sdk_version:E,_sdk_version:E,_sdk_name:E,wechat_openid:E,wechat_unionid:E}},this._ready=!1,this._extraData={},this.storage=new(this._get("storage")),this.logger=new(this._get("logger")),this.request=this._get("request"),this._initPlugin(),this._process()}return i(e,[{key:"_initPlugin",value:function(){var t=this;try{e.plugins.reduce((function(e,n){var i=n.plugin;return e.push(new i(t)),e}),this._pluginInstances)}catch(e){}}},{key:"_on",value:function(e,t){if(!e||!t||"function"!=typeof t)return;this._listeners[e]||(this._listeners[e]=[]),this._listeners[e].push(t)}},{key:"_once",value:function(e,t){var n=this;if(!e||!t||"function"!=typeof t)return;this._on(e,(function i(r,o){t(r,o),n._off(e,i)}))}},{key:"_emit",value:function(e,t){var n=this;"report"!==e&&(void 0===t?this.logger.info("触发".concat(e)):this.logger.info("触发".concat(e,"："),t));var i=this._listeners[e];if(i&&i.length)try{l(i).forEach((function(e){return e(n,t)}))}catch(e){}}},{key:"_off",value:function(e,t){if(!e||!this._listeners[e]||!this._listeners[e].length)return;if(t){var n=this._listeners[e].indexOf(t);-1!==n&&this._listeners[e].splice(n,1)}else this._listeners[e]=[]}},{key:"_get",value:function(t){return e.adapters[t](this)}},{key:"appId",get:function(){return this._appId},set:function(e){if("number"!=typeof e)throw new Error("app_id must be a number");this._appId=e}},{key:"_mergeEnv",value:function(e){this._emit("before-merge",e),function(e,t){Object.keys(t).forEach((function(n){if("evtParams"===n)e.evtParams=Object.assign(Object.assign({},e.evtParams||{}),t.evtParams||{});else if("_staging_flag"===n)e.evtParams=Object.assign(Object.assign({},e.evtParams||{}),{_staging_flag:t._staging_flag});else{var i=n,r=t[n];if(null===r)return!1;var o="";if(i.indexOf(".")>-1){var a=p(i.split("."),2);o=a[0],i=a[1]}"platform"===i&&(r="mp"),"os_version"!==i&&"mp_platform"!==i||(r="".concat(r)),o?("headers"===o&&(o="header"),"user"===o||"header"===o?e[o][i]=r:e.header.custom[i]=r):e.user.hasOwnProperty(i)?["user_type","ip_addr_id"].indexOf(i)>-1?e.user[i]=Number(r):["user_id","user_unique_id","ssid"].indexOf(i)>-1?e.user[i]=String(r):["user_is_auth","user_is_login"].indexOf(i)>-1?e.user[i]=Boolean(r):["device_id"].indexOf(i)>-1&&(e.user[i]=r):e.header.hasOwnProperty(i)&&-1===["app_id"].indexOf(i)?e.header[i]=r:e.header.custom[i]=r}}))}(this._envInfo,e)}},{key:"_setExtraData",value:function(e,t){this._extraData[e]=t}},{key:"_getExtraData",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"";return e?this._extraData[e]:this._extraData}},{key:"destroy",value:function(){this._pluginInstances.forEach((function(e){return e.destroy()}))}},{key:"_process",value:function(){var e=this;this._once("init",(function(){if(e._emit("instantiation"),e._envInfo.header.app_id=e.appId,e._options.enable_ab_test&&e._emit("ab-test"),e._options.enable_filter_list&&e._emit("fetch-white"),e._options.enable_filter_crawler&&e._emit("filter-crawler"),e._emit("device"),e._on("try-report",(function(){if(!e._sended)return;if(!e._tokenOK)return;if(e._options.auto_report&&!e.isQuick&&!e._launchOK)return;e._emit("start-report")})),e._once("send",(function(){e._sended=!0,e._emit("try-report")})),e._on("token-ok",(function(){e._tokenOK=!0,e._emit("try-report")})),e._options.auto_report&&!e.isQuick&&e._once("launch-ok",(function(){e._launchOK=!0,e._emit("try-report")})),e._options.auto_report?e._emit("auto-report"):e._emit("not-auto-report"),e._options.enable_custom_webid)return e._emit("custom-process"),void 0;e._on("config",(function(t,n){var i=n.user_unique_id,r=N(n,["user_unique_id"]);if(e._mergeEnv(r),e._options.enable_third)return;if(void 0!==i){i="".concat(i);var o=e._envInfo.user;o._user_unique_id?(o._user_unique_id=i,e._emit("profile-clear")):o.web_id?o.user_unique_id!==i&&(o._user_unique_id=i,e._emit("profile-clear"),e._tokenOK=!1,e._emit("stop-report"),e._emit("fetch-ssid",{user_unique_id:i,web_id:o.web_id})):(o._user_unique_id=i,e._emit("profile-clear"))}})),e._on("fetch-ssid-complete",(function(t,n){var i=n.status;if(2===i)e._emit("fetch-ssid-complete-done",n),e._emit("token-ok");else if(1===i)e.logger.error("获取ssid失败");else if(0===i){var r=e._envInfo.user;e._emit("fetch-ssid",{user_unique_id:r._user_unique_id,web_id:r.web_id})}})),e._once("fetch-token-complete",(function(t,n){if(n){var i=e._envInfo.user,r=i._user_unique_id,o=i.user_unique_id,a=i.web_id;r?o!==r?e._emit("fetch-ssid",{user_unique_id:r,web_id:a}):(delete e._envInfo.user._user_unique_id,e._emit("token-ok")):e._emit("token-ok")}else e._once("fetch-webid-complete",(function(t,n){if(n){var i=e._envInfo.user,r=i._user_unique_id,o=i.web_id;e._envInfo.user.user_unique_id=o,r?e._emit("fetch-ssid",{user_unique_id:r,web_id:o}):e._emit("token-ok")}else e.logger.error("获取webid失败")})),e._emit("fetch-webid")})),e._emit("fetch-token")}))}},{key:"_tokenMiddleware",value:function(e){this._tokenOK?e():this._once("token-ok",(function(){e()}))}},{key:"_sendMiddleware",value:function(e){this._sended?e():this._once("send",(function(){e()}))}},{key:"_whiteMiddleware",value:function(e){if(!this._options.enable_filter_list)return e(),void 0;this._whiteOK?e():this._once("fetch-white-complete",(function(){e()}))}},{key:"_compose",value:function(e){return e.reverse().reduce((function(e,t){return function(){return t((function(){return e()}))}}))}}],[{key:"use",value:function(t){var n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{type:"plugin"},i=n.name,r=n.type;if("plugin"===r)if(i){for(var o=!1,a=0,s=e.plugins.length;a<s;a++){var u=e.plugins[a];u.name&&u.name===i&&(o=!0,e.plugins[a].plugin=t)}o||e.plugins.push({name:i,plugin:t})}else e.plugins.push({plugin:t});else"adapter"===r&&(e.adapters[i]=t(e,n))}}]),e}();R.adapters={},R.plugins=[];var V,K,L,H=function(e){o(r,R);var n=c(r);function r(){var e;return t(this,r),(e=n.call(this))._hooks={},e}return i(r,[{key:"on",value:function(e,t){if(!e||!t||"function"!=typeof t)return;this._hooks[e]||(this._hooks[e]=[]),this._hooks[e].push(t)}},{key:"once",value:function(e,t){var n=this;if(!e||!t||"function"!=typeof t)return;this.on(e,(function i(r){t(r),n.off(e,i)}))}},{key:"off",value:function(e,t){if(!e||!this._hooks[e]||!this._hooks[e].length)return;if(t){var n=this._hooks[e].indexOf(t);-1!==n&&this._hooks[e].splice(n,1)}else this._hooks[e]=[]}},{key:"emit",value:function(e,t){if(!e||!this._hooks[e]||!this._hooks[e].length)return;l(this._hooks[e]).forEach((function(e){try{e(t)}catch(e){}}))}}]),r}(),W=(void 0,function(e,t){var n={};for(var i in e)Object.prototype.hasOwnProperty.call(e,i)&&t.indexOf(i)<0&&(n[i]=e[i]);if(null!=e&&"function"==typeof Object.getOwnPropertySymbols){var r=0;for(i=Object.getOwnPropertySymbols(e);r<i.length;r++)t.indexOf(i[r])<0&&Object.prototype.propertyIsEnumerable.call(e,i[r])&&(n[i[r]]=e[i[r]])}return n}),F=function(n){o(a,H);var r=c(a);function a(){return t(this,a),r.apply(this,arguments)}return i(a,[{key:"getConfig",value:function(){return JSON.parse(JSON.stringify(this._envInfo))}},{key:"init",value:function(t){if(this._inited)return;if(this._inited=!0,"object"===e(t)){if(this.appId=t.app_id,void 0!==t.log&&(this.logger.setEnable(t.log),delete t.log),void 0===t.report_channel&&void 0!==t.report_domain){var n=t.report_domain;n=parseInt(String(n),10),[1,2].includes(n)||(n=1),t.report_channel=1===n?"cn":"sg"}void 0!==t.channel&&(t.report_channel=t.channel),this._options=Object.assign(Object.assign({},this._options),t);var i=t.disable_storage,r=t.enable_storage;void 0!==r?(i=!(r=!!r),this._options.disable_storage=i,this._options.enable_storage=r):void 0!==i&&(r=!(i=!!i),this._options.disable_storage=i,this._options.enable_storage=r)}else this.appId=t;this._emit("init")}},{key:"config",value:function(e){if(!this._inited)return;void 0!==e.log&&(this.logger.setEnable(e.log),delete e.log);var t=(e=Object.assign({},e)).user_unique_id,n=W(e,["user_unique_id"]);void 0!==t&&this._emit("config",{user_unique_id:t}),this._emit("before-config",n),this._emit("config",n)}},{key:"send",value:function(){if(!this._inited)return;this._emit("send")}},{key:"_filterEvent",value:function(e){var t=e.current,n=e.isBlack,i=e.eventNames,r=e.eventParams,o=e.whiteEvents,a=t.event,s=t.params;if(o.includes(a))return t;if(n){if(i.includes(a))return null;if(r[a]&&Array.isArray(r[a]))return Object.assign(Object.assign({},t),{params:Object.keys(s).filter((function(e){return!r[a].includes(e)})).reduce((function(e,t){return e[t]=s[t],e}),{})})}else{if(!i.length)return t;if(!i.includes(a))return null;if(r[a]&&Array.isArray(r[a]))return Object.assign(Object.assign({},t),{params:Object.keys(s).filter((function(e){return r[a].includes(e)})).reduce((function(e,t){return e[t]=s[t],e}),{})})}return t}},{key:"_verify",value:function(e){this._verifyStatus&&this._emit("verify",e)}},{key:"_event",value:function(e,t){var n=this,i=arguments.length>2&&void 0!==arguments[2]&&arguments[2];if(this._getExtraData(C))return;var r=function(){if(i||!n._options.enable_filter_list)return n._emit(e,t),n._verify(t),void 0;var r=n._getExtraData("white");if(!r||void 0===r.is_black)return n._emit(e,t),n._verify(t),void 0;var o=n._getExtraData("white-events"),a=r||{},s=a.is_black,u=void 0===s?1:s,c=a.events,f=void 0===c?[]:c,h=a.params,p=void 0===h?{}:h;if(Array.isArray(t)){var l=t.reduce((function(e,t){var i=n._filterEvent({current:t,isBlack:u,eventNames:f,eventParams:p,whiteEvents:o});return null!==i&&e.push(i),e}),[]);l.length&&(n._emit(e,l),n._verify(l))}else{var d=n._filterEvent({current:t,isBlack:u,eventNames:f,eventParams:p,whiteEvents:o});null!==d&&(n._emit(e,d),n._verify(d))}},o=["immediate-report-batch","immediate-report"].includes(e);this._whiteMiddleware((function(){o?n._ready?r():n._once("start-report",(function(){r()})):r()}))}},{key:"_mergeAbToEvent",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]&&arguments[1];if(this._options.enable_ab_test){var n=e.local_time_ms,i=this._getExtraData("ab_versions")||[],r=null;if(t)i.length>0&&(r=i[i.length-1].ab);else for(var o=0,a=i.length;o<a;o++){var s=i[o],u=s.time,c=s.ab;if(u>n)break;r=c}return Object.assign(Object.assign({},e),r?{ab_sdk_version:r}:{})}return e}},{key:"_createEvent",value:function(e,t){var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:b(),i=this._getExtraData("session_id");return Object.assign(Object.assign({event:e,params:O(t)?Object.assign({},t):{}},i?{session_id:i}:{}),{local_time_ms:n})}},{key:"event",value:function(e){var t=this,n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},i=arguments.length>2&&void 0!==arguments[2]&&arguments[2];if(Array.isArray(e)){if(e.length>30){for(;this.event(e.splice(0,30)),0!==e.length;);return!0}var r=[],o=b(),a=function(e,n,i){if(e&&"string"==typeof e){var a=i;(!a||"number"!=typeof a||a>o)&&(a=o),r.push(t._mergeAbToEvent(t._createEvent(e,n,a)))}};return e.forEach((function(e){if(Array.isArray(e)){var t=p(e,3),n=t[0],i=t[1],r=t[2];a(n,i,r)}else{var o=e.event,s=e.params,u=e.local_time_ms;a(o,s,u)}})),r.length&&this._event("immediate-report-batch",r),!0}var s=this._mergeAbToEvent(this._createEvent(e,n));if(i)return this._event("immediate-report",s),!0;var u=this._options,c=u.disable_storage,f=u.enable_storage;if(c||!f)return this._event("immediate-report",s),!0;return this._event("event",s),!0}}]),a}(),M=function(){function e(n){t(this,e),this.sdk=n,this.apply()}return i(e,[{key:"getUrl",value:function(e){var t=this.sdk._options,n=t.channel_domain,i=t.enable_custom_webid,r="";if(n)r=n;else{var o=t.report_channel;Object.keys(x).includes(o)||(o="cn"),r=x[o]}switch(e){case"report":return"".concat(r).concat(i?"/list/":"/v2/event/list");case"webid":return"".concat(r).concat("/v2/user/webid");case"ssid":return"".concat(r).concat("/v2/user/ssid");case"profile":return"".concat(r).concat("/profile/list");case"utm":return"".concat(r).concat("/service/2/mp_campaigns")}}},{key:"_merge",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:[],n=this.sdk._envInfo,i=n.user,r=n.header,o=n.evtParams,a=e.map((function(e){return e.event&&!t.includes(e.event)&&o&&Object.keys(o).forEach((function(t){void 0===e.params[t]&&(e.params[t]=o[t])})),e.params=JSON.stringify(e.params),e})),s=JSON.parse(JSON.stringify({events:a,user:i,header:r}));return s.header.headers&&(s.header.headers=JSON.stringify(s.header.headers)),s.local_time=Math.floor(b()/1e3),[s]}},{key:"destroy",value:function(){this.sdk=null}}]),e}(),J=function(n){o(a,M);var r=c(a);function a(){return t(this,a),r.apply(this,arguments)}return i(a,[{key:"apply",value:function(){var e=this;this.maxExpire=7344e6,this.minUpdateTime=432e7,this.sdk._on("fetch-token",(function(t){e.fetchCacheToken((function(t){return e.sdk._emit("fetch-token-complete",t)}))})),this.sdk._on("fetch-webid",(function(t){e.requestWebid((function(t){return e.sdk._emit("fetch-webid-complete",t)}))})),this.sdk._on("fetch-ssid",(function(t,n){e.requestSsid(n,{completeHook:function(t){return e.sdk._emit("fetch-ssid-complete-hook",t)},complete:function(t){return e.sdk._emit("fetch-ssid-complete",t)}})})),this.sdk._on("instantiation",(function(t){var n=e.sdk,i=n.storage;if(!n._options.enable_compatible_old)return;var r=e.getKey(),o=i.get(r);if(o&&"string"==typeof o){e.sdk.logger.info("cacheToken-string",o);try{var a=o=JSON.parse(o),s=a.web_id,u=a.ssid,c=a.timestamp;e.sdk.logger.info("cacheToken-parse",o),s&&u?c||i.set(r,Object.assign(Object.assign({},o),{timestamp:+new Date})):i.remove(r)}catch(t){i.remove(r),e.sdk.logger.error(t)}}}))}},{key:"fetchCacheToken",value:function(e){var t=this.sdk.storage,n=this.getKey(),i=t.get(n);if(i)return this._hasCacheToken(e,i),void 0;e(!1)}},{key:"_hasCacheToken",value:function(e,t){var n=this,i=t;if("string"==typeof i)try{i=JSON.parse(i)}catch(e){}var r=i,o=r.user_unique_id,a=r.web_id,s=r.ssid,u=r.timestamp;if(!a||!o||!u)return e(!1),!1;var c=b()-parseFloat(u);if(c>=this.maxExpire)return e(!1),!1;var f=function(){n.sdk.emit("fetch-token",Object.assign({},i));var t=n.sdk._envInfo.user;t.user_unique_id=o,t.web_id=a,t.ssid=s,e(!0)};if(c>=this.minUpdateTime)return this._updateWebid(a,(function(t){if(!t)return e(!1),!1;f()})),!1;f()}},{key:"requestWebid",value:function(t){var n=this,i=this.sdk.appId;this.sdk.request({url:this.getUrl("webid"),method:"POST",data:{app_id:i,url:"-",user_agent:"-",referer:"-",user_unique_id:""},header:Object.assign({},S),success:function(i){n.sdk.logger.info("success-webid",e(i),i);var r=(i||{}).data;if(!r)return t(!1),!1;0!==r.e?t(!1):n._hasWebid(t,r)},fail:function(){n.sdk.logger.info("fail-webid"),t(!1)}})}},{key:"_hasWebid",value:function(e,t){var n=t.web_id,i=t.ssid,r=this.sdk._envInfo.user;r.web_id=n,r.ssid=i,this.sdk.storage.set(this.getKey(),Object.assign(Object.assign({},r),{user_unique_id:n,timestamp:b()})),e(!0)}},{key:"_updateWebid",value:function(e,t){var n=this,i=this.sdk.appId;this.sdk.request({url:"".concat(this.getUrl("webid"),"/").concat(e,"/update"),method:"POST",data:{app_id:i,url:"-",user_agent:"-",referer:"-",user_unique_id:""},header:Object.assign({},S),success:function(e){var i=(e||{}).data;if(!i)return t(!1),void 0;0!==i.e?t(!1):n._hasUpdateWebid(t)},fail:function(){t(!1)}})}},{key:"_hasUpdateWebid",value:function(e){var t=this.sdk.storage,n=this.getKey(),i=t.get(n);t.set(n,Object.assign(Object.assign({},i||{}),{timestamp:b()})),e(!0)}},{key:"requestSsid",value:function(t,n){var i=this,r=this.sdk.appId,o=this.sdk._envInfo.user,a=n.completeHook,s=n.complete,u=function(e){return s({status:e,info:t})};this.sdk.request({url:this.getUrl("ssid"),method:"POST",data:{app_id:r,web_id:t.web_id,user_unique_id:"".concat(t.user_unique_id)},header:Object.assign({},S),success:function(n){if(i.sdk.logger.info("success-ssid",e(n),n),t.user_unique_id!==o._user_unique_id)return u(0),void 0;var r=(n||{}).data;if(!r)return u(1),void 0;0!==r.e?u(1):(a&&a({info:t,data:r}),i._hasSsid(u,t,r))},fail:function(){if(i.sdk.logger.info("fail-ssid"),t.user_unique_id!==o._user_unique_id)return u(0),void 0;u(1)}})}},{key:"_hasSsid",value:function(e,t,n){var i=this.sdk.storage,r=this.sdk._envInfo.user,o=n.ssid;r.web_id=t.web_id,r.ssid=o,r.user_unique_id=t.user_unique_id,delete r._user_unique_id;var a=this.getKey(),s=(i.get(a)||{}).timestamp,u=void 0===s?b():s;i.set(a,Object.assign(Object.assign({},r),{timestamp:u})),e(2)}},{key:"getKey",value:function(){var e=this.sdk,t=e.appId,n=e._keyPrefix;return"".concat(n,"tokens_").concat(t)}}]),a}(),B=function(e){o(r,M);var n=c(r);function r(){return t(this,r),n.apply(this,arguments)}return i(r,[{key:"apply",value:function(){var e=this;this.cache=[],this.time=100,this.delaying=0,this.sdk._once("init",(function(t){t._options.enable_compatible_old&&e._transformOldKey()})),this.sdk._on("event",(function(t,n){e.event(n)})),this.sdk._on("clear-storage",(function(t){e.sdk.storage.remove(e.getKey())}))}},{key:"_transformOldKey",value:function(){var e=this.sdk.storage,t=this.getKey(!0);try{var n=e.get(t,!0);if(n){e.remove(t);var i=this.getKey(),r=e.get(i,!0);e.set(i,[].concat(l(n),l(r)),!0)}}catch(e){}}},{key:"event",value:function(e){var t=this;this.cache.push(e),this.delaying>0&&clearTimeout(this.delaying),this.delaying=setTimeout((function(){var e=l(t.cache);t.cache=[],t.delaying=0,t.sync(e)}),this.time)}},{key:"sync",value:function(e){var t=this.sdk,n=t._ready,i=t.storage,r=t._options.max_batch_event,o=this.getKey(),a=i.get(o);a&&!Array.isArray(a)&&(a=[],this.sdk._emit("clear-storage"));var s=[].concat(l(a||[]),l(e));if(!i.set(o,s))return i.remove(o),this.sdk._event("immediate-report-batch",s),void 0;n&&r&&s.length>=r&&(this.sdk._emit("interval-report"),this.sdk._emit("report"))}},{key:"getKey",value:function(){var e=arguments.length>0&&void 0!==arguments[0]&&arguments[0],t=this.sdk,n=t.appId,i=t._keyPrefix;return e?"".concat(i,"events"):"".concat(i,"events_").concat(n)}}]),r}(),$=function(e){o(s,M);var n=c(s);function s(){return t(this,s),n.apply(this,arguments)}return i(s,[{key:"apply",value:function(){var e=this;this.extOptions={},this.reporting=!1,this.time=3e3,this.splitNumber=30,this.splitTime=1500,this.intervalIng=0,this.sdk._once("report-option",(function(t,n){e.extOptions=n})),this.sdk._once("init",(function(t){var n=e.sdk._options,i=n.disable_storage,r=n.enable_storage;i&&!r||e._reissue()})),this.sdk._on("start-report",(function(t){e.sdk._ready=!0;var n=e.sdk._options,i=n.disable_storage,r=n.enable_storage;i&&!r||(e.interval(),e.report())})),this.sdk._on("report",(function(t,n){e.report(n)})),this.sdk._on("immediate-report",(function(t,n){e.immediateReport(n)})),this.sdk._on("immediate-report-batch",(function(t,n){e.immediateReportBatch(n)})),this.sdk._on("stop-report",(function(){e.sdk._ready=!1;var t=e.sdk._options,n=t.disable_storage,i=t.enable_storage;n&&!i||e.stop()})),this.sdk._on("interval-report",(function(){e.interval()})),this.sdk._on("ab-report",(function(t,n){var i=n.event,r=n.hook;e.immediateReport(i,r)})),this.sdk._on("clear-storage",(function(t){e.sdk.storage.remove(e.getKey("reports"))}))}},{key:"_reissue",value:function(){var e=this.sdk.storage,t=this.getKey("reports");try{var n=e.get(t,!0);n&&(e.remove(t),this._reissueProcess(n))}catch(e){}}},{key:"_reissueProcess",value:function(e){var t=this,n=Object.keys(e);!function i(){if(n.length){for(var r=[],o=0;o<t.splitNumber;o++)n.length&&r.push(n.shift());if(r.length){var a=[];r.forEach((function(t){e[t]&&e[t][0]&&a.push(e[t][0])})),t.doPost(a,t.getRandom(),(function(e){}))}setTimeout(i,t.splitTime)}}()}},{key:"interval",value:function(){var e=this,t=this.sdk._options.report_interval;this.stop(),this.intervalIng=setTimeout((function(){e.sdk._emit("report"),e.intervalIng=0,e.interval()}),t)}},{key:"stop",value:function(){this.intervalIng>0&&clearTimeout(this.intervalIng),this.intervalIng=0}},{key:"report",value:function(e){var t=this.sdk.storage,n=this.getKey("events"),i=t.get(n);if(!i||!i.length)return;t.remove(n);var r=this.sdk._options.max_storage_num;if(r>0){var o=this.getKey("reports"),a=t.get(o)||{},s=Object.keys(a);if(s.length>=r){var u=s.sort((function(e,t){var n=e.split(".")[0],i=t.split(".")[0];return parseFloat(n)-parseFloat(i)}));u&&u[0]&&this.removeReport(u[0])}}var c=this.mergeEvent(i);this.post(c)}},{key:"immediateReport",value:function(e,t){var n=this,i=this.mergeEvent([e]);if(t)try{i=t(i)}catch(e){}var r=this.getRandom();this.doPost(i,r,(function(t,r){n.sdk._emit("report-complete",{event:e,status:t,user:i[0].user,responseData:r})}))}},{key:"immediateReportBatch",value:function(e){var t=this,n=this.mergeEvent(e),i=this.getRandom();this.doPost(n,i,(function(n,i){t.sdk._emit("batch-report-complete",{event:e,status:n,responseData:i})}))}},{key:"mergeEvent",value:function(e){var t=[].concat(l(D),[U]);return this._merge(e,t)}},{key:"post",value:function(e,t){var n=this,i="";if(t)i=t;else{var o=this.sdk.storage,a=this.getKey("reports"),s=o.get(a)||{};i=this.getRandom(),o.set(a,Object.assign(Object.assign({},s||{}),r({},i,e)))}this.doPost(e,i,(function(e){2!==e&&1!==e||n.removeReport(i)}))}},{key:"doPost",value:function(e,t,n){var i=this,r=this.extOptions,o=r.dataType,a=r.header,s=r.method,u=this.sdk._options,c=u.report_url,f=u.event_verify_url;f&&this.sdk.request({url:"".concat("".concat(f).replace(/\/+$/,""),"/v1/list_test"),method:"POST",data:e}),this.sdk._emit("report-before",e),this.sdk.request({url:c||"".concat(this.getUrl("report"),"?tea_sdk_random=").concat(t),method:s||"POST",dataType:o,data:e,header:Object.assign(Object.assign({},S),a||{}),success:function(e){var t=(e||{}).data;if(!t)return n(1,t),void 0;0!==t.e?n(1,t):n(2)},fail:function(){n(0)},complete:function(){for(var e=arguments.length,t=new Array(e),n=0;n<e;n++)t[n]=arguments[n];i.sdk._emit("report-after",t)}})}},{key:"getKey",value:function(e){var t=this.sdk,n=t.appId,i=t._keyPrefix;return"".concat(i).concat(e,"_").concat(n)}},{key:"getRandom",value:function(){var e=b(),t=Math.floor(1e5*Math.random());return"".concat(e,".").concat(t)}},{key:"removeReport",value:function(e){try{var t=this.sdk.storage,n=this.getKey("reports"),i=t.get(n);i&&i[e]&&(i=Object.keys(i).reduce((function(t,n){return n!==e&&(t[n]=i[n]),t}),{})),t.set(n,i)}catch(e){}}},{key:"destroy",value:function(){this.stop(),h(a(s.prototype),"destroy",this).call(this)}}]),s}(),z={cn:"https://toblog.ctobsnssdk.com",va:"https://toblog.itobsnssdk.com",sg:"https://toblog.tobsnssdk.com"},G=(void 0,function(e,t){var n={};for(var i in e)Object.prototype.hasOwnProperty.call(e,i)&&t.indexOf(i)<0&&(n[i]=e[i]);if(null!=e&&"function"==typeof Object.getOwnPropertySymbols){var r=0;for(i=Object.getOwnPropertySymbols(e);r<i.length;r++)t.indexOf(i[r])<0&&Object.prototype.propertyIsEnumerable.call(e,i[r])&&(n[i[r]]=e[i[r]])}return n}),Q=function(e,t){t.logger.info(e)},X=function(n){o(a,M);var r=c(a);function a(){var e;return t(this,a),(e=r.apply(this,arguments)).fetchStatus=0,e.callbacks=[],e.data=null,e.versions=[],e.externalVersions=null,e.refreshStatus=1,e.clear=!1,e}return i(a,[{key:"apply",value:function(){var e=this;this.sdk._once("ab-test",(function(){var t=e.sdk,n=t.appId,i=t._envInfo,r=t._options,o=r.auto_report,a=r.clear_ab_cache_on_user_change;e.appId=n,e.domain=e._getDomain(),e.envConfig=i,e.clear=a,e.sdk._once(o?"token-ok":"start-report",(function(){e.fetch(),e.sdk._on("fetch-ssid",(function(t){e.refreshStatus=0})),e.sdk._on("fetch-ssid-complete-hook",(function(t,n){var i=n.data;(null==i?void 0:i.ssid)!==e.user.ssid&&e.clear&&(e.versions=[],e.data={},e._updateVersions())})),e.sdk._on("fetch-ssid-complete",(function(t,n){var i=n.status;e.refreshStatus=1,2===i?e.envConfig.user.ssid!==e.user.ssid?e.fetch():e._executeCb():1===i&&(2!==e.fetchStatus?e.fetch():e._executeCb())}))})),e._check(),e.sdk._on("ab-var",(function(t,n){var i=n.name,r=n.defaultValue,o=n.callback;e.getVar(i,r,o)})),e.sdk._on("ab-allvars",(function(t,n){e.getAllVars(n)})),e.sdk._on("ab-exposure",(function(t,n){e.sdk._emit("ab-report",{event:e.sdk._createEvent("abtest_exposure",{}),hook:function(e){var t=e[0];return t.events[0].ab_sdk_version=t.header.ab_sdk_version="".concat(n),[t]}})})),e.sdk._on("ab-refresh",(function(t,n){var i=n.params,r=n.callback;e.fetch(i,r)}))})),this.processExternal()}},{key:"fetch",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},t=arguments.length>1?arguments[1]:void 0;if(!this.domain)return this.fetchStatus=2,this._fetchComplete(null),void 0;var n=this.envConfig,i=n.user,r=n.header,o=r.headers,a=G(r,["headers"]);this.user=Object.assign({},i);var s=Object.assign(Object.assign(Object.assign({},a),o),e||{});t?this._fetch(s,{success:function(e){t&&t(e)}}):this._fetch(s)}},{key:"processExternal",value:function(){var e=this;this.sdk._once("instantiation",(function(t){var n=!1,i=function(t,n){n.forEach((function(t){var n=t.events;(void 0===n?[]:n).forEach((function(t){if(D.includes(t.event))return;t.ab_sdk_version=t.ab_sdk_version?"".concat(t.ab_sdk_version,",").concat(e.externalVersions):e.externalVersions}))}))},r=function(t,r){if(0===r&&n)return;e.externalVersions=t,n?t||(e.sdk._off("report-before",i),n=!1):(n=!0,e.sdk._on("report-before",i))};e._getExternalVersion(t.appId,r),e.sdk._on("external-ab-version",(function(t,n){e._setExternalCache(t.appId,n),r(n,1)}))}))}},{key:"_getExternalVersion",value:function(e,t){var n=this._getExternalCache(e);n&&t(n,0)}},{key:"getAllVars",value:function(e){if("function"!=typeof e)return Q("回调函数必须为一个函数",this.sdk);var t={callback:e,type:1};2===this.fetchStatus&&1===this.refreshStatus?this._getAllVars(t):this.callbacks.push(t)}},{key:"getVar",value:function(e,t,n){if(!e)return Q("变量名不能为空",this.sdk);if(void 0===t)return Q("变量没有默认值",this.sdk);if("function"!=typeof n)return Q("回调函数必须为一个函数",this.sdk);var i={name:e,defaultValue:t,callback:function(e){try{n(e)}catch(e){}},type:0};2===this.fetchStatus&&1===this.refreshStatus?this._getVar(i):this.callbacks.push(i)}},{key:"_check",value:function(){var e=this._checkExpiration(this.appId);if(e){var t=e.ab_version,n=e.data;t&&t.length&&(this.versions=t,this.data=n,this._configVersions())}}},{key:"_fetchComplete",value:function(e){if(e){this._setDataCache(this.appId,e),this.data=e;var t=[];Object.keys(e).forEach((function(n){var i=e[n].vid;i&&t.push(i)}));var n=this.versions.length;this.versions=this.versions.filter((function(e){return t.includes(e)})),this.versions.length!==n&&this._updateVersions()}this._executeCb()}},{key:"_executeCb",value:function(){var e=this;this.callbacks.length>0&&(this.callbacks.forEach((function(t){return e[0===t.type?"_getVar":"_getAllVars"](t)})),this.callbacks=[])}},{key:"_getAllVars",value:function(e){(0,e.callback)(this.data?JSON.parse(JSON.stringify(this.data)):{})}},{key:"_getVar",value:function(t){var n=t.name,i=t.defaultValue,r=t.callback,o=this.data;if(!o)return r(i),void 0;if("object"===e(o[n])&&void 0!==o[n].val){var a=o[n],s=a.vid,u=a.val;return s&&(this.versions.includes(s)||(this.versions.push(s),this._updateVersions()),this.sdk._emit("ab-exposure",s)),r(u),void 0}r(i)}},{key:"_updateVersions",value:function(){this._setVersionCache(this.appId,this.versions),this._configVersions()}},{key:"_configVersions",value:function(){var e=this.versions.join(",");this.sdk._mergeEnv({ab_sdk_version:e});var t="ab_versions",n=this.sdk._getExtraData(t)||[];this.sdk._setExtraData(t,[].concat(l(n),[{time:b(),ab:e}])),this.sdk._emit("ab-version-change",e)}},{key:"_getDomain",value:function(){!0;var e=this.sdk._options,t=e.channel_domain,n=e.ab_channel_domain,i="";if(true,n)i=n;else if(t)i=t;else{var r=e.report_channel;Object.keys(z).includes(r)||(r="cn"),i=z[r]}return i}},{key:"_url",value:function(){return"".concat(this.domain).concat("/service/2/abtest_config/")}},{key:"_fetch",value:function(e){var t=this,n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},i=n.success,r=void 0===i?function(){}:i,o=n.fail,a=void 0===o?function(){}:o;this.fetchStatus=1;var s=this._url();this.sdk.request({url:s,data:{header:Object.assign(Object.assign({aid:this.appId},this.user||{}),e||{})},method:"POST",header:Object.assign({},S),success:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};if(0===t.refreshStatus)return;t.fetchStatus=2;var n=e||{},i=n.data,o=(i=void 0===i?{}:i).data,s=void 0===o?{}:o;s?(t._fetchComplete(s),r&&r(s)):(t._fetchComplete(null),a&&a())},fail:function(){if(0===t.refreshStatus)return;t.fetchStatus=2,a&&a(),t._fetchComplete(null)}})}},{key:"_getStorageKey",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0;return 1===t?"".concat("__tea_sdk_ab_version_external","_").concat(e):"".concat("__tea_sdk_ab_version","_").concat(e)}},{key:"_getExternalCache",value:function(e){var t=this.sdk.storage;try{return t.get(this._getStorageKey(e,1))}catch(e){}return null}},{key:"_setExternalCache",value:function(e,t){var n=this.sdk.storage;try{var i=this._getStorageKey(e,1);t?n.set(i,t):n.remove(i)}catch(e){}}},{key:"_getCache",value:function(e){var t=this.sdk.storage,n={ab_version:[],data:null,timestamp:b()};try{n=t.get(this._getStorageKey(e))||n}catch(e){}return n}},{key:"_setCache",value:function(e,t){var n=this.sdk.storage;try{var i=this._getCache(e);n.set(this._getStorageKey(e),Object.assign(Object.assign({},i),t))}catch(e){}}},{key:"_setVersionCache",value:function(e,t){this._setCache(e,{ab_version:t,timestamp:b()})}},{key:"_setDataCache",value:function(e,t){this._setCache(e,{data:t})}},{key:"_checkExpiration",value:function(e){var t=this.sdk.storage,n=this._getCache(e),i=n.timestamp;if(b()-i>=2592e6){try{t.remove("__tea_sdk_ab_version")}catch(e){}return null}return n}}]),a}(),Y=(void 0,function(e,t){var n={};for(var i in e)Object.prototype.hasOwnProperty.call(e,i)&&t.indexOf(i)<0&&(n[i]=e[i]);if(null!=e&&"function"==typeof Object.getOwnPropertySymbols){var r=0;for(i=Object.getOwnPropertySymbols(e);r<i.length;r++)t.indexOf(i[r])<0&&Object.prototype.propertyIsEnumerable.call(e,i[r])&&(n[i[r]]=e[i[r]])}return n}),Z=function(e){o(r,M);var n=c(r);function r(){return t(this,r),n.apply(this,arguments)}return i(r,[{key:"apply",value:function(){var e=this;this.cache=[],this.expire=21600,this.timeout=5e3,this.sdk._once("fetch-white",(function(t){e.initWhite((function(){e.sdk._whiteOK=!0,e.sdk._emit("fetch-white-complete")}))}))}},{key:"initWhite",value:function(e){var t=this.sdk.storage,n=this.getKey(),i=t.get(n);this.processCache(e,i,(function(e){t.set(n,e)}))}},{key:"processCache",value:function(e,t,n){var i=this;if(t&&t.timestamp&&(this.sdk._setExtraData("white",t.data),(void 0!==t.interval?t.interval:this.expire)+t.timestamp>b()))return e(),void 0;this.requestWhite((function(t,r){var o=function(e,t){n(Object.assign({timestamp:b(),interval:void 0!==e?e:i.expire},t?{data:t}:{}))};if(t){var a=r.event_list,s=r.fetch_interval;if(!a)return i.sdk._setExtraData("white",null),o(s,null),e(),void 0;var u=a.is_block,c=Y(a,["is_block"]),f=Object.assign(Object.assign({},c),{is_black:u});return i.sdk._setExtraData("white",f),o(s,f),e(),void 0}o(void 0,null),e()}))}},{key:"_requestWhite",value:function(e){setTimeout((function(){e(!0,{event_list:{is_block:0,events:["app_launch","xxx1","xxx2"],params:{xxx3:["xxx"]}},fetch_interval:3600})}),3e3)}},{key:"requestWhite",value:function(e){var t=this.sdk.appId;this.sdk.request({url:"",method:"POST",data:{header:{aid:t},event_filter:1},header:Object.assign({},S),timeout:5e3,success:function(t){var n=t.data;try{n.config&&n.config.event_list?e(!0,n.config):e(!1,null)}catch(t){e(!1,null)}},fail:function(){e(!1,null)}})}},{key:"getKey",value:function(){var e=this.sdk,t=e.appId,n=e._keyPrefix;return"".concat(n,"white_").concat(t)}}]),r}(),ee=function(e){o(r,M);var n=c(r);function r(){return t(this,r),n.apply(this,arguments)}return i(r,[{key:"apply",value:function(){var e=this;this.lastId=0,this.lastOnceId=0,this.duration=6e4,this.cache={},this.buffer=[],this.sdk._on("profile-set",(function(t,n){e._check()&&e.setProfile(n)})),this.sdk._on("profile-set-once",(function(t,n){e._check()&&e.setOnceProfile(n)})),this.sdk._on("profile-unset",(function(t,n){e._check()&&e.unsetProfile(n)})),this.sdk._on("profile-increment",(function(t,n){e._check()&&e.incrementProfile(n)})),this.sdk._on("profile-append",(function(t,n){e._check()&&e.appendProfile(n)})),this.sdk._on("profile-clear",(function(t){e.cache={}})),this.sdk._on("start-report",(function(){if(!e.buffer.length)return;e._report(l(e.buffer)),e.buffer=[]}))}},{key:"_check",value:function(){return!!this.sdk._options.enable_profile}},{key:"setProfile",value:function(e){var t=this,n=this._debounce(e);if(!n)return;this._putCache(n);var i=this._filter(n,(function(e){return"string"==typeof e||"number"==typeof e||t._isArray(e)}));this.report({event:"__profile_set",params:i,local_time_ms:this.ms()})}},{key:"setOnceProfile",value:function(e){var t=this,n=this._debounce(e,!0);if(!n)return;this._putCache(n);var i=this._filter(n,(function(e){return"string"==typeof e||"number"==typeof e||t._isArray(e)}));this.report({event:"__profile_set_once",params:i,local_time_ms:this.ms()})}},{key:"incrementProfile",value:function(e){if(!e)return;var t=this._filter(e,(function(e){return"number"==typeof e}));this.report({event:"__profile_increment",params:t,local_time_ms:this.ms()})}},{key:"unsetProfile",value:function(e){if(!e||"string"!=typeof e)return;var t={};t[e]="1",this.report({event:"__profile_unset",params:t,local_time_ms:this.ms()})}},{key:"appendProfile",value:function(e){var t=this;if(!e||!this._isObject(e)||this._isEmpty(e))return;var n=this._filter(e,(function(e){return"string"==typeof e||t._isArray(e)}));this.report({event:"__profile_append",params:n,local_time_ms:this.ms()})}},{key:"report",value:function(e){this.sdk._ready?this._report([e]):this.buffer.push(e)}},{key:"_report",value:function(e){var t=this._merge(e,l(D));this.sdk.request({url:"".concat(this.getUrl("profile")),method:"POST",dataType:"json",data:t,header:Object.assign({},S),success:function(e){},fail:function(){}})}},{key:"ms",value:function(){return b()}},{key:"_debounce",value:function(e){var t=this,n=arguments.length>1&&void 0!==arguments[1]&&arguments[1];if(!e||!this._isObject(e)||this._isEmpty(e))return;var i=Object.keys(e),r=this.ms(),o=i.filter((function(i){var o=t.cache[i];if(o&&(n||t._compare(o.val,e[i])&&r-o.timestamp<t.duration))return!1;return!0})).reduce((function(t,n){return t[n]=e[n],t}),{});if(!(i=Object.keys(o)).length)return;return o}},{key:"_putCache",value:function(e){var t=this,n=this.ms();Object.keys(e).forEach((function(i){t.cache[i]={val:t._clone(e[i]),timestamp:n}}))}},{key:"_clone",value:function(e){try{return JSON.parse(JSON.stringify(e))}catch(t){return e}}},{key:"_compare",value:function(e,t){return JSON.stringify(e)===JSON.stringify(t)}},{key:"_filter",value:function(e,t){return Object.keys(e).reduce((function(n,i){var r=e[i];return t(r)&&(n[i]=r),n}),{})}},{key:"_isObject",value:function(e){return"[object Object]"===Object.prototype.toString.call(e)}},{key:"_isArray",value:function(e){return"function"==typeof Array.isArray?Array.isArray(e):"[object Array]"===Object.prototype.toString.call(e)}},{key:"_isEmpty",value:function(e){return!Object.keys(e).length}},{key:"destroy",value:function(){h(a(r.prototype),"destroy",this).call(this)}}]),r}(),te=function(e){o(a,M);var n=c(a);function a(){return t(this,a),n.apply(this,arguments)}return i(a,[{key:"apply",value:function(){var e=this;this.sdk._on("instantiation",(function(e){var t=function(){try{var e=(new Date).getTimezoneOffset();return{timezone:Math.floor(Math.abs(e)/60),offset:60*e}}catch(e){return{timezone:8,offset:-28800}}}();e._mergeEnv({timezone:t.timezone,tz_offset:t.offset})})),this.sdk._on("before-config",(function(t,n){if(void 0!==n.gender&&([1,2,"1","2"].includes(n.gender)?n.gender=n.gender<2?"male":"female":delete n.gender),!!t._options.enable_profile){var i={};["nick_name","gender","avatar_url"].forEach((function(e){void 0!==n[e]&&(i[e]=n[e],delete n[e])})),e.sdk._emit("profile-set",i)}})),this.sdk._on("before-merge",(function(t,n){if(!!t._options.enable_profile){var i="rangers_mp_from_uid";void 0!==n[i]&&(e.sdk._emit("profile-set",r({},i,n[i])),delete n[i])}}))}}]),a}();!function(e){e.Mp="mp",e.Quick="quick",e.QG="qg"}(V||(V={})),function(e){e.Launch="launch",e.Terminate="terminate",e.Auto="auto",e.Event="event",e.LogData="log_data",e.Profile="profile"}(K||(K={})),function(e){e.Net="net",e.FailNet="f_net",e.FailData="f_data"}(L||(L={}));var ne=function(e){o(r,M);var n=c(r);function r(){var e;return t(this,r),(e=n.apply(this,arguments)).platform=V.Mp,e}return i(r,[{key:"apply",value:function(){var e=this;this.sdk._on("instantiation",(function(t,n){e.aid=t.appId,e.isAuto=!!t._options.auto_report,e.isPrivate=!!t._options.channel_domain})),this.sdk._on("report-before",(function(t,n){if(e.isPrivate)return;if(e.isTest())return;e.parse(n).forEach((function(t){e.collect(t)}))})),this.sdk._on("report-complete",(function(t,n){if(e.isPrivate)return;if(e.isTest())return;var i=n.status;if(2===i)return;var r=n.event,o=n.user,a=n.responseData,s=[{events:o?[r]:r}],u=1===i?L.FailData:L.FailNet,c=e.parse(s,u);u===L.FailData?e.collect({key:K.Event,state:u},a.sc||c.length):c.forEach((function(t){e.collect(t)}))})),this.sdk._on("app-hide",(function(t){e.commit()}))}},{key:"parse",value:function(e){var t=this,n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:L.Net,i=[];return e&&e.forEach((function(e){e.events.forEach((function(e){var r=e.event;if(r===U)return;if(t.isTest(e))return;i.push({key:t.getKey(r),state:n})}))})),i}},{key:"collect",value:function(e){var t=this,n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:1,i=e.key,r=e.state;this.cache||(this.cache=new Map);var o=this.cache,a=function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:1;return{count:e,state:r,key:i,params_for_special:U,platform:t.platform,aid:t.aid,_staging_flag:1}},s=n;if(o.has(i)){var u=o.get(i);if(u.has(r)){var c=u.get(r);c.count+=n,s=c.count}else u.set(r,a(n))}else{var f=new Map;f.set(r,a(n)),o.set(i,f)}s>=100&&this.critical(i,r)}},{key:"report",value:function(e){var t=this;if(!e)return;var n=this.sdk.appId;if(!n)return;var i=[];e.forEach((function(e){e.forEach((function(e){e.aid||(e.aid=n);var r=t.sdk._createEvent(U,e);i.push(r)}))})),i.length>0&&this.sdk._emit("immediate-report-batch",i)}},{key:"getKey",value:function(e){switch(e){case A.appOnShow:return K.Launch;case A.appOnHide:return K.Terminate;default:if(Object.values(A).includes(e))return K.Auto;if(D.includes(e))return K.Profile;return K.Event}}},{key:"critical",value:function(e,t){this.commit()}},{key:"commit",value:function(){if(this.isPrivate)return;if(this.isTest())return;var e=this.cache;this.cache=null,this.report(e)}},{key:"isTest",value:function(e){var t,n;if(e)return!!JSON.parse(e.params)._staging_flag;return!!(null===(n=null===(t=this.sdk._envInfo)||void 0===t?void 0:t.evtParams)||void 0===n?void 0:n._staging_flag)}}]),r}(),ie=(void 0,function(e,t){var n={};for(var i in e)Object.prototype.hasOwnProperty.call(e,i)&&t.indexOf(i)<0&&(n[i]=e[i]);if(null!=e&&"function"==typeof Object.getOwnPropertySymbols){var r=0;for(i=Object.getOwnPropertySymbols(e);r<i.length;r++)t.indexOf(i[r])<0&&Object.prototype.propertyIsEnumerable.call(e,i[r])&&(n[i[r]]=e[i[r]])}return n}),re=function(e){o(r,F);var n=c(r);function r(){return t(this,r),n.apply(this,arguments)}return i(r,[{key:"stash",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};this._getExtraData("session_id");var n=this._mergeAbToEvent(this._createEvent(e,t),!0),i="stash",r=this._getExtraData(i)||[];return r=[].concat(l(r),[n]),this._setExtraData(i,r),!0}},{key:"commit",value:function(){var e="stash",t=this._getExtraData(e)||[];return t.length>0&&(this.event(t),this._setExtraData(e,[])),!0}},{key:"setProfile",value:function(e){this.logger.warn("[deprecated]请示用profileSet、profileSetOnce等新方法")}},{key:"setOnceProfile",value:function(e){this.setProfile(e)}},{key:"getVar",value:function(e,t,n){this._emit("ab-var",{name:e,defaultValue:t,callback:n})}},{key:"getAllVars",value:function(e){this._emit("ab-allvars",e)}},{key:"getAbSdkVersion",value:function(){var e=this._getExtraData("ab_versions")||[];return e.length>0?e[e.length-1].ab:""}},{key:"onAbSdkVersionChange",value:function(e){var t=this;if(e&&"function"==typeof e){var n=function(t,n){setTimeout((function(){try{e&&e(n)}catch(e){}}),0)},i=this._getExtraData("ab_version_change_cb")||new Map;return i.set(e,n),this._setExtraData("ab_version_change_cb",i),this._on("ab-version-change",n),function(){i.delete(e),t._off("ab-version-change",n)}}return function(){}}},{key:"offAbSdkVersionChange",value:function(e){if(e&&"function"==typeof e){var t=this._getExtraData("ab_version_change_cb");if(!t||!t.has(e))return;var n=t.get(e);t.delete(e),n&&this._off("ab-version-change",n)}}},{key:"getToken",value:function(e){var t=this,n=function(){var n=t._envInfo.user;return e(Object.assign({},n))};this._tokenOK?n():this._once("token-ok",(function(){n()}))}},{key:"autoInitializationRangers",value:function(e){var t=e.onTokenReady,n=ie(e,["onTokenReady"]);this.init(Object.assign(Object.assign({},n),{log:!1,enable_third:!0})),t&&this.getToken((function(e){var n=e.web_id;try{"function"==typeof t&&t("".concat(n))}catch(e){}})),this.send()}},{key:"profileSet",value:function(e){this._emit("profile-set",e)}},{key:"profileSetOnce",value:function(e){this._emit("profile-set-once",e)}},{key:"profileUnset",value:function(e){this._emit("profile-unset",e)}},{key:"profileIncrement",value:function(e){this._emit("profile-increment",e)}},{key:"profileAppend",value:function(e){this._emit("profile-append",e)}},{key:"setExternalAbVersion",value:function(e){this._emit("external-ab-version","string"==typeof e&&e?"".concat(e).trim():null)}},{key:"getAbConfig",value:function(e,t){this._emit("ab-refresh",{params:e,callback:t})}},{key:"setWebIDviaUnionID",value:function(e){if(!e)return;var t=w(e);this.config({web_id:t,wechat_unionid:e})}},{key:"setWebIDviaOpenID",value:function(e){if(!e)return;var t=w(e);this.config({web_id:t,wechat_openid:e})}},{key:"createWebViewUrl",value:function(e){var t;if(!e||!this._tokenOK)return e;var n=null===(t=this._envInfo.user)||void 0===t?void 0:t.web_id;if(!n)return e;return this._createWebViewUrl(e,n)}},{key:"createWebViewUrlAsync",value:function(e){var t,n=this;if(!e)return Promise.resolve(e);return this._tokenOK?Promise.resolve(this._createWebViewUrl(e,null===(t=this._envInfo.user)||void 0===t?void 0:t.web_id)):new Promise((function(t){n._once("token-ok",(function(){var i;t(n._createWebViewUrl(e,null===(i=n._envInfo.user)||void 0===i?void 0:i.web_id))}))}))}},{key:"_createWebViewUrl",value:function(e,t){e=g(e);var n=/([^?#]+)(\?[^#]*)?(#.*)?/.exec(e),i=n[1]||"",r=n[2]||"",o=n[3]||"",a=r?k(r.substring(1)):{};return a.Web_ID=t,e=i+m("",a)+o}}]),r}();re.use(J,{name:"token",type:"plugin"}),re.use(B,{name:"event",type:"plugin"}),re.use($,{name:"report",type:"plugin"}),re.use(X,{name:"ab",type:"plugin"}),re.use(Z,{name:"white",type:"plugin"}),re.use(ee,{name:"pf",type:"plugin"}),re.use(te,{name:"beforeConfig",type:"plugin"}),re.use(ne,{name:"trace",type:"plugin"});var oe,ae=(void 0,function(e,t){var n={};for(var i in e)Object.prototype.hasOwnProperty.call(e,i)&&t.indexOf(i)<0&&(n[i]=e[i]);if(null!=e&&"function"==typeof Object.getOwnPropertySymbols){var r=0;for(i=Object.getOwnPropertySymbols(e);r<i.length;r++)t.indexOf(i[r])<0&&Object.prototype.propertyIsEnumerable.call(e,i[r])&&(n[i[r]]=e[i[r]])}return n});!function(e){e.Normal="synchronize",e.Once="setOnce"}(oe||(oe={})),function(e){o(s,M);var n=c(s);function s(){return t(this,s),n.apply(this,arguments)}i(s,[{key:"apply",value:function(){var e=this;this.autoId=0,this.lastId=0,this.lastOnceId=0,this.duration=1e4,this.data=null,this.autoStatus=!1,this.sdk._once("init",(function(t){var n,i=e.sdk._options,o=i.auto_profile,a=i.profile_channel;if(e.channel=a,e.urls=(r(n={},oe.Normal,e.getProfileUrl(oe.Normal)),r(n,oe.Once,e.getProfileUrl(oe.Once)),n),e.autoStatus=!!o,!e.autoStatus)return;e.sdk._once("start-report",(function(){e.start()}))})),this.sdk._on("profile-info",(function(t,n){e.sdk._mergeEnv(n)})),this.sdk._on("profile",(function(t,n){if(!e.autoStatus)return;e.setProfile(n)})),this.sdk._on("profile-once",(function(t,n){if(!e.autoStatus)return;e.setOnceProfile(n)}))}},{key:"getProfileUrl",value:function(e){var t=I[this.channel],n=this.sdk.appId;return"".concat(t,"/service/api/v3/userprofile/").concat(n,"/").concat(e)}},{key:"getData",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},t=JSON.parse(JSON.stringify(this.sdk._envInfo)),n=t.user,i=t.header,r=i.headers,o=i.otherHeader,a=r.custom,s=ae(r,["custom"]);return{user:{web_id:n.web_id,ssid:n.ssid,user_unique_id:n.user_unique_id},header:Object.assign(Object.assign({},o||{}),s||{}),profile:Object.assign(Object.assign({},a||{}),e||{})}}},{key:"start",value:function(){var e=this;if(this.autoId>0)return;this.upPre(oe.Normal),this.autoId=setInterval((function(){e.upPre(oe.Normal)}),this.duration)}},{key:"stop",value:function(){this.autoId>0&&clearInterval(this.autoId)}},{key:"setProfile",value:function(e){var t=b();(!this.lastId||t-this.lastId>=this.duration)&&(this.sdk._mergeEnv(e),this.upPre(oe.Normal,e),this.lastId=t)}},{key:"setOnceProfile",value:function(e){var t=b();(!this.lastOnceId||t-this.lastOnceId>=this.duration)&&(this.sdk._mergeEnv(e),this.upPre(oe.Once,e),this.lastOnceId=t)}},{key:"upPre",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},n=this.getData(t);this.data&&JSON.stringify(this.data)===JSON.stringify(n)||(this.up(this.urls[e],n),this.data=n)}},{key:"up",value:function(e,t){this.profile(e,t)}},{key:"profile",value:function(e,t){var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:function(e){};this.sdk.request({url:e,method:"POST",data:t,header:Object.assign({},S),success:function(e){0!==e.data.e?n(1):n(2)},fail:function(){n(0)}})}},{key:"destroy",value:function(){this.stop(),h(a(s.prototype),"destroy",this).call(this)}}])}();var se,ue=function(e){return(t="logverify",n=function(e){return(n=t,n.split("").map((function(e){return e.charCodeAt(0)}))).reduce((function(e,t){return e^t}),e);var n},function(e){return e.match(/.{1,2}/g).map((function(e){return parseInt(e,16)})).map(n).map((function(e){return String.fromCharCode(e)})).join("")})(e);var t,n},ce=function(e){o(r,M);var n=c(r);function r(){return t(this,r),n.apply(this,arguments)}return i(r,[{key:"apply",value:function(){var e=this;this.test=!1,this.testRequestNumber=0,this.buffer=[],this.sdk._on("verify-domain",(function(t,n){if(n)try{var i=ue(n);i&&/^https?:\/\//.test(i)&&(e.domain=i),e.sdk.logger.info("verify domain ".concat(i))}catch(e){}})),this.sdk._once("verify-open",(function(t,n){e.sdk.logger.info("verify open ".concat(JSON.stringify(n))),e.userInfo=n,e.sdk._verifyStatus=!0,e.sdk._on("verify",(function(t,n){try{e._pushBuffer(JSON.parse(JSON.stringify(n)))}catch(e){}})),e.login()})),this.sdk._on("verify-close",(function(t){e.userInfo=null,e.sdk._verifyStatus=!1,e.sdk._off("verify")}))}},{key:"_getUrl",value:function(e){var t="";if(this.domain)switch(e){case"login":t="".concat(this.domain).concat("/simulator/limited_mobile/try_link");break;case"report":t="".concat(this.domain).concat("/simulator/limited_mobile/log")}return t}},{key:"login",value:function(){var e=this,t=this._getUrl("login");if(!t)return;var n=this._prepareHeader().header;this.sdk.request({url:t,method:"POST",data:Object.assign(Object.assign({header:Object.assign(Object.assign({},n||{}),{aid:n.app_id})},this.userInfo?{nick_name:this.userInfo.nickName}:{}),{host_version:(n.custom||{}).mp_platform_app_version||"",sync_id:this.syncId||""}),success:function(t){try{var n=t.data.data,i=n.retry,r=n.sync_id,o=n.token;if(e.syncId=r,e.token=o,e.test&&e.testRequestNumber>3)return e.report(),void 0;0===i||(1===i?e.loginLoop():2===i&&e.report())}catch(t){e.loginLoop()}},fail:function(){e.loginLoop()}})}},{key:"loginLoop",value:function(){var e=this;this.test&&this.testRequestNumber++,setTimeout((function(){e.login()}),1e3)}},{key:"report",value:function(){var e=this,t=this._getUrl("report");if(!t)return;var n=this._prepareHeader().header,i=this.buffer;this.buffer=[],this.sdk.request({url:t,method:"POST",data:{header:Object.assign(Object.assign({},n||{}),{aid:n.app_id}),token:this.token||"",event_v3:i||[]},success:function(t){try{!0===t.data.data.keep?e.reportLoop():e._destroy()}catch(t){e.reportLoop()}},fail:function(){e.reportLoop()}})}},{key:"reportLoop",value:function(){var e=this;setTimeout((function(){e.report()}),1e3)}},{key:"_pushBuffer",value:function(e){var t=this;(Array.isArray(e)?l(e):[e]).forEach((function(e){e.params=JSON.parse(e.params),t.buffer.push(e)}))}},{key:"_prepareHeader",value:function(){var e=this.sdk._envInfo,t=e.user,n=e.header;return JSON.parse(JSON.stringify({user:t,header:n}))}},{key:"_destroy",value:function(){this.buffer=[],this.syncId="",this.token=""}}]),r}(),fe=(void 0,function(e,t){var n={};for(var i in e)Object.prototype.hasOwnProperty.call(e,i)&&t.indexOf(i)<0&&(n[i]=e[i]);if(null!=e&&"function"==typeof Object.getOwnPropertySymbols){var r=0;for(i=Object.getOwnPropertySymbols(e);r<i.length;r++)t.indexOf(i[r])<0&&Object.prototype.propertyIsEnumerable.call(e,i[r])&&(n[i[r]]=e[i[r]])}return n});!function(e){e[e.Crawler=1129]="Crawler"}(se||(se={}));var he,pe=function(n){o(a,M);var r=c(a);function a(){var e;return t(this,a),(e=r.apply(this,arguments)).Events=A,e.queue=[],e.hasLaunch=!1,e.sdkInited=!1,e.missAppLaunch=!1,e.missAppShow=!1,e.autoConfig={appLaunch:!0,appTerminate:!0,appError:!0,pageShow:!0,pageHide:!0,pageShare:!0,pageFavorite:!0},e}return i(a,[{key:"apply",value:function(){var t=this,n=this.sdk;this.which=this.getWhich(),this.init(),n._on("instantiation",(function(e){t.sdkInited=!0;var n=e._getExtraData("white-events");e._setExtraData("white-events",[].concat(l(n||[]),l(Object.values(A)))),t.firstTimeProcess()})),n._on("filter-crawler",(function(e){var n=t.which;void 0!==n.getLaunchOptionsSync&&((n.getLaunchOptionsSync()||{}).scene===se.Crawler&&e._setExtraData(C,!0))})),n._on("start-report",(function(){if(t.queue.length>0)for(;;){var e=t.queue.shift();if(!e)break;var n=e.name,i=e.params;t._emitEvent(n,i)}})),n._once("auto-report",(function(){t.open=!0;var n=t.sdk._options;"object"===e(n.auto_report)&&(t.autoConfig=Object.assign(Object.assign({},t.autoConfig),n.auto_report||{})),t.missAppLaunch&&t.appLaunch(t.missAppLaunchInfo||{}),t.missAppShow&&t.appShow(t.missAppShowInfo||{}),t.ssidComplete()})),n._once("not-auto-report",(function(){t.open=!1,t.missAppLaunch&&t.appLaunch(t.missAppLaunchInfo||{})})),this.verify()}},{key:"getWhich",value:function(){return{}}},{key:"report",value:function(e,t){this.sdk._ready?this._emitEvent(e,t):this.queue.push({name:e,params:t})}},{key:"_emitEvent",value:function(e,t){var n=this.sdk;this.hasLaunch||e!==A.appOnShow||(this.hasLaunch=!0),n.event(e,t,!0)}},{key:"makeUuid",value:function(){return y()}},{key:"_firstTimeKey",value:function(){var e=this.sdk,t=e.appId,n=e._keyPrefix;return"".concat(n,"first_").concat(t)}},{key:"firstTimeProcess",value:function(){var e=this._firstTimeKey(),t=this.sdk.storage,n=t.get(e);if(n===P.False)return this.firstTime=P.False,void 0;n||(this.firstTime=P.True),t.set(e,P.False)}},{key:"getFirstTimeValue",value:function(e){var t;return e?t=P.True:(t=this.firstTime,this.firstTime===P.True&&(this.firstTime=P.False)),t}},{key:"init",value:function(){this.sdk._setExtraData("session_id",this.makeUuid()),this.proxyApp(),this.proxyPage(),this.proxyComponent()}},{key:"ssidComplete",value:function(){var e=this,t=this.sdk;t._on("fetch-ssid-complete-hook",(function(t,n){if(!e.hasLaunch)return;if(e.queue.length>0)return;var i=t._ready;t._ready=!0,t.appHide(!0),t._ready=i})),t._on("fetch-ssid-complete-done",(function(t,n){if(!e.hasLaunch)return;if(e.queue.length>0)return;t.appLaunch(!0)}))}},{key:"proxyApp",value:function(){var e=this.proxyAppHacks();this.appHacks=e,this.proxyAppSdkMethods(),this.proxyAppBefore(),this.proxyAppDo(),this.proxyAppAfter()}},{key:"appLaunch",value:function(e){var t=this.sdk,n=e;if(!e.path)if(e.args)n=e.args;else try{JSON.stringify(e)}catch(e){n={query:{}}}var i={info:n};t.emit(t.types.TransformInfo,{type:"App.onLaunch",rawInfo:e,wrapInfo:i}),n=i.info}},{key:"_utm",value:function(e){var t=this,n=this.sdk,i=e.query,r=e.scene;r&&n._setExtraData("scene",r);O(i)&&function(e){var t={},i=!1;Object.keys(e).forEach((function(n){T.includes(n)&&(i=!0,t[n]=g(e[n]))})),i&&n._mergeEnv(t)}(i);var o=i||{},a=o.tr_token,s=void 0===a?"":a,u=o.surl_token,c=void 0===u?"":u,f=o.scene,h=void 0===f?"":f,p=s||c;if(h){var l=k(g("".concat(h)));l.tr_token&&(p=l.tr_token),n._setExtraData("scene_extra_query",l)}var d=!!this.hasLaunch;p&&d&&this.sdk._emit("stop-report");var _=function(){d||n._emit("launch-ok"),p&&d&&t.sdk._emit("start-report")},v=function(){var e=n.appId,t=n._keyPrefix;return"".concat(t,"utm_").concat(e)},y=function(e,t){var i=v();try{var r=n.storage.get(i);r||(r={}),r[e]={utms:t,timestamp:b()},n.storage.set(i,r)}catch(e){}};if(p){var m=function(e){var t=v();try{var i=n.storage.get(t),r=b(),o=[];if(O(i)&&Object.keys(i).forEach((function(e){i[e]&&i[e].timestamp+864e7<r&&o.push(e)})),o.length>0&&(o.forEach((function(e){delete i[e]})),n.storage.set(t,i)),i&&i[e])return i[e]}catch(e){}return null}(p);m?(n._mergeEnv(m.utms||{}),_()):!function(e,i,r){n.request({url:t.getUrl("utm"),method:"GET",data:{tr_token:e},success:i,fail:r,timeout:3e3})}(p,(function(e){var t=(e||{}).data,i=(t=void 0===t?{}:t).code,r=void 0===i?-1:i,o=t.data,a=void 0===o?{}:o,s=t.message,u=void 0===s?"":s;if(0===r){var c={},f=!1;O(a)&&Object.keys(a).forEach((function(e){T.includes(e)&&(f=!0,c[e]=a[e])})),f&&n._mergeEnv(c),y(p,c)}else 40002===r&&y(p,{});0!==r&&n.logger.warn(u||""),_()}),(function(){_()}))}else _()}},{key:"appShow",value:function(t){var n=arguments.length>1&&void 0!==arguments[1]&&arguments[1],i=this.sdk,r=this;i._mergeEnv({evtParams:{$current_path:void 0,$current_query:void 0}});var o=t;if(!t.path)if(t.args)o=t.args;else try{JSON.stringify(t)}catch(e){o={query:{}}}var a={info:o};if(i.emit(i.types.TransformInfo,{type:"App.onShow",rawInfo:t,wrapInfo:a}),o=a.info,this._utm(o),!this.open)return i._emit("app-show"),void 0;if(!this.autoConfig.appLaunch)return;!n&&i._emit("app-show",o);var s=y();i._setExtraData("session_id",s),i._setExtraData("session_start",b());var u=o,c=u.query,f=(c=void 0===c?{}:c).from_uid,h=void 0===f?"":f;c.from_user_unique_id;var p=c.share_depth,l=void 0===p?0:p;i._setExtraData("from_uid",h||"0"),i._setExtraData("share_depth",Number(l)||0),i._setExtraData("session_depth",0);var d=o,_=d.referrerInfo,v=fe(o,["referrerInfo"]),m=v.query,k=fe(v,["query"]),O=Object.assign(Object.assign({},m),_),w={},x=i._getExtraData("scene_extra_query");x&&Object.keys(x).forEach((function(e){w["query_".concat(e)]=x[e]})),Object.keys(O).forEach((function(t){if(!T.includes(t)&&"scene"!==t){var n=O[t];if("object"===e(n))return;"from_title"===t&&(n=encodeURIComponent(g(O[t]))),w["query_".concat(t)]=n}}));var E=r.getFirstTimeValue(n),S=Object.assign(Object.assign({session_id:s,$is_first_time:E},k),w);try{JSON.stringify(S)}catch(e){S=Object.assign({session_id:s,$is_first_time:E},w);try{JSON.stringify(S)}catch(e){S={session_id:s,$is_first_time:E}}}i.emit(i.types.ExtendAppLaunch,S),r.report(A.appOnShow,S),n||h&&i._mergeEnv({rangers_mp_from_uid:h||"0"})}},{key:"proxyAppHacks",value:function(){var e=this.sdk,t=this,n={onLaunch:function(e){if(!t.sdkInited)return t.missAppLaunch=!0,t.missAppLaunchInfo=e,void 0;t.appLaunch(e)},onShow:function(e){var n=arguments.length>1&&void 0!==arguments[1]&&arguments[1];if(!t.sdkInited)return t.missAppShow=!0,t.missAppShowInfo=e,void 0;t.appShow(e,n)},onHide:function(){var n=arguments.length>0&&void 0!==arguments[0]&&arguments[0];if(!t.sdkInited)return;if(!t.open)return e._emit("app-hide"),void 0;if(!t.autoConfig.appTerminate)return;var i=e._getExtraData("session_start"),r=Math.ceil((b()-i)/1e3),o=e._getExtraData("session_depth"),a=e._getExtraData("session_id"),s=e._getExtraData("scene"),u=getCurrentPages()||[],c=u[u.length-1],f=c.route,h=c.__route__,p=c.options,l=void 0===p?{}:p,d=f||h,_=function(){var e={};if(O(l)){if(l.scene){var t=k(g("".concat(l.scene)));Object.keys(t).forEach((function(n){e["query_".concat(n)]=t[n]}))}Object.keys(l).forEach((function(t){if(!T.includes(t)&&"scene"!==t){var n=l[t];"from_title"===t&&(n=encodeURIComponent(g(l[t]))),e["query_".concat(t)]=n}}))}return Object.assign(Object.assign({exit_page:d,session_duration:r,session_depth:o,session_id:a},s?{scene:s}:{}),e)},v=_();e.emit(e.types.ExtendAppTerminate,v),t.report(A.appOnHide,v),!n&&e._emit("app-hide")},onError:function(n){if(!t.sdkInited)return;if(!t.open)return;if(!t.autoConfig.appError)return;var i=e._getExtraData("session_id"),r={on_error:n,session_id:i};e.emit(e.types.ExtendAppError,r),t.report(A.appOnError,r)}};return this.proxyAppHacksExtend(n),n}},{key:"proxyAppHacksExtend",value:function(e){}},{key:"proxyAppSdkMethods",value:function(){var e=this.sdk,t=this.which,n=this.appHacks;e.appLaunch=function(e){var i={};void 0!==t.getLaunchOptionsSync&&(i=t.getLaunchOptionsSync()),n.onShow(i||{},e)},e.appHide=function(e){n.onHide(e)},e.appError=function(e){n.onError(e)},this.proxyAppSdkMethodsExtend(n)}},{key:"proxyAppSdkMethodsExtend",value:function(e){}},{key:"proxyAppBefore",value:function(){}},{key:"proxyAppDo",value:function(){var e=this.appHacks,t=App;return App=function(n){return Object.keys(e).forEach((function(t){var i=n[t];n[t]=function(){for(var n=arguments.length,r=new Array(n),o=0;o<n;o++)r[o]=arguments[o];try{e[t].apply(this,r)}catch(e){}return i&&i.apply(this,r)}})),t(n)},t}},{key:"proxyAppAfter",value:function(){}},{key:"proxyPage",value:function(){var e=this.proxyPageHacks();this.pageHacks=e,this.proxyPageSdkMethods(),this.proxyPageBefore(),this.proxyPageDo(),this.proxyPageAfter()}},{key:"proxyPageHacks",value:function(){var e=this.sdk,t=this,n={onShow:function(){if(!t.sdkInited)return;if(e._emit("page-show"),!t.open)return;if(!t.autoConfig.pageShow)return;var n=getCurrentPages(),i=n[n.length-1],r=i.route,o=i.__route__,a=i.options,s=void 0===a?{}:a,u=r||o,c=Number(e._getExtraData("session_depth"))||0;e._setExtraData("session_depth",c+1);var f=e._getExtraData("session_id"),h=e._getExtraData("scene"),p={};if(O(s)){if(s.scene){var l=k(g("".concat(s.scene)));Object.keys(l).forEach((function(e){p["query_".concat(e)]=l[e]}))}Object.keys(s).forEach((function(e){if(!T.includes(e)&&"scene"!==e){var t=s[e];"from_title"===e&&(t=encodeURIComponent(g(s[e]))),p["query_".concat(e)]=t}}))}var d=Object.assign(Object.assign({path:u,session_id:f},h?{scene:h}:{}),p);d.title=e._getPageTitle(u);var _=null,v=e._getExtraData("recently_page");if(v?_=v:n.length>1&&(_=e._getRouteInfo(2,n)),_){var y=_,m=y.path,w=void 0===m?"":m,x=y.query,E=void 0===x?{}:x;d.refer_path=w,d.refer_query=JSON.stringify(E)}e.emit(e.types.ExtendPageShow,d),e._setExtraData("recently_page",{path:u,query:s}),e._setExtraData("current_pv_info",{time:b(),params:Object.assign({},d)});t.report(A.pageOnShow,d)},onHide:function(){if(!t.sdkInited)return;if(e._emit("page-hide"),!t.open)return;if(!t.autoConfig.pageHide||!t.autoConfig.pageShow)return;var n=e._getExtraData("current_pv_info");if(!n)return;e._setExtraData("current_pv_info",null);var i=n.time,r=n.params,o=b()-i;o=o<0?0:o;var a=Object.assign(Object.assign({},r||{}),{duration:o});e.emit(e.types.ExtendPageHide,a),t.report(A.pageOnHide,a)},onUnload:function(){n.onHide()},onShareAppMessage:function(n){if(!t.sdkInited)return;if(!t.open)return n;if(!t.autoConfig.pageShare)return n;var i=e._envInfo.user,r=i.ssid,o=i.user_unique_id,a=Number(e._getExtraData("share_depth"))+1,s=e._getExtraData("session_id"),u=!1;if(n.path){var c=n.path,f=n.title,h="from_user_unique_id=".concat(o,"&share_depth=").concat(a,"&from_title=").concat(f);r&&(h+="&from_uid=".concat(r));var p="",l=c.indexOf("#");-1!==l&&(p=c.substr(l),c=c.substr(0,l));var d=c.indexOf("?");if(-1!==d){var _=c.substr(d+1),v=c.substr(0,d),y=k(_);y.from_user_unique_id&&(u=!0,y=Object.keys(y).filter((function(e){if("from_uid"===e||"from_user_unique_id"===e||"share_depth"===e||"from_title"===e)return!1;return!0})).reduce((function(e,t){return e[t]=y[t],e}),{})),c=Object.keys(y).length>0?m(v,y)+"&".concat(h):v+"?".concat(h)}else c+="?".concat(h);n.path=c+p}if(!u){var g=function(e){var t=e.title,n=e.path,i=void 0===n?"":n;return Object.assign(Object.assign({title:t,path:i,page_path:i.split("?")[0]},r?{query_from_uid:r}:{}),{query_share_depth:a,session_id:s})}(n);e.emit(e.types.ExtendPageShare,g),t.report(A.pageOnShareAppMessage,g)}return Object.assign(Object.assign(Object.assign({},n),r?{from_uid:r}:{}),{share_depth:a})},onAddToFavorites:function(n){if(!t.sdkInited)return;if(!t.open)return;if(!t.autoConfig.pageFavorite)return;var i=n||{},r=i.res,o=i.result,a=getCurrentPages(),s=a[a.length-1],u=s.route,c=s.__route__,f=u||c,h=o.query,p=fe(o,["query"]),l=Object.assign({url_path:(null==r?void 0:r.webViewUrl)||f,url_query:h},p);e.emit(e.types.ExtendPageFavorite,l),t.report(A.pageOnAddToFavorites,l)}};return this.proxyPageHacksExtend(n),n}},{key:"proxyPageHacksExtend",value:function(e){}},{key:"proxyPageSdkMethods",value:function(){var e=this.sdk,t=this.pageHacks;e.predefinePageview=function(){t.onShow()},e.predefinePageviewHide=function(){t.onHide()},e.shareAppMessage=function(e){return t.onShareAppMessage(e)},e.addToFavorites=function(e,n){return t.onAddToFavorites({res:e,result:n})},this.proxyPageSdkMethodsExtend(t)}},{key:"proxyPageSdkMethodsExtend",value:function(e){}},{key:"proxyPageBefore",value:function(){}},{key:"proxyPageDo",value:function(){var e=this.pageHacks,t=this,n=Page;return Page=function(i){return Object.keys(e).forEach((function(n){var r=i[n];"onShareAppMessage"===n?r&&(i[n]=function(){for(var i=arguments.length,o=new Array(i),a=0;a<i;a++)o[a]=arguments[a];var s=r?r.apply(this,o):{};if(!t.sdkInited)return;if(!t.open)return s;try{var u=e[n].apply(this,[s]);s.path=u.path}catch(e){}return s}):"onAddToFavorites"===n?r&&(i[n]=function(){for(var i=arguments.length,o=new Array(i),a=0;a<i;a++)o[a]=arguments[a];var s=r?r.apply(this,o):{};if(!t.sdkInited)return;if(!t.open)return s;try{e[n].apply(this,[{res:o[0],result:s}])}catch(e){}return s}):i[n]=function(){for(var t=arguments.length,i=new Array(t),o=0;o<t;o++)i[o]=arguments[o];try{e[n].apply(this,i)}catch(e){}return r&&r.apply(this,i)}})),n(i)},n}},{key:"proxyPageAfter",value:function(){}},{key:"proxyComponent",value:function(){var e=Component,t=this.pageHacks,n=this;Component=function(i){return i.methods||(i.methods={}),Object.keys(t).forEach((function(e){var r=i.methods[e];"onShareAppMessage"===e?r&&(i.methods[e]=function(){for(var i=arguments.length,o=new Array(i),a=0;a<i;a++)o[a]=arguments[a];var s=r?r.apply(this,o):{};if(!n.sdkInited)return;if(!n.open)return s;try{var u=t[e].apply(this,[s]);s.path=u.path}catch(e){}return s}):"onAddToFavorites"===e?r&&(i.methods[e]=function(){for(var i=arguments.length,o=new Array(i),a=0;a<i;a++)o[a]=arguments[a];var s=r?r.apply(this,o):{};if(!n.sdkInited)return;if(!n.open)return s;try{t[e].apply(this,[{res:o[0],result:s}])}catch(e){}return s}):i.methods[e]=function(){for(var n=arguments.length,i=new Array(n),o=0;o<n;o++)i[o]=arguments[o];try{t[e].apply(this,i)}catch(e){}return r&&r.apply(this,i)}})),e(i)}}},{key:"verifyDo",value:function(e){var t=this.sdk,n=this.which,i=function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};if(e&&e.start_rangers_data_check)return e.start_rangers_data_check;return""}(e);if(t.logger.info("verify ".concat(i)),i){t._emit("verify-domain",i);var r=function(e){e||(e={nickName:"未知",avatarUrl:""}),t._emit("verify-open",e),t.logger.info("".concat(JSON.stringify(e)))};n.getSetting({success:function(e){t.logger.info("getSetting success"),e.authSetting["scope.userInfo"]?(t.logger.info("getSetting scope.userInfo success"),void 0!==n.getUserInfo?n.getUserInfo({success:function(e){t.logger.info("getUserInfo success");var n=e.userInfo,i=n.nickName,o=n.avatarUrl;r({nickName:i,avatarUrl:o})},fail:function(){t.logger.info("getUserInfo fail"),r()}}):void 0!==n.getOpenUserInfo&&n.getOpenUserInfo({success:function(e){t.logger.info("getUserInfo success");try{var n=JSON.parse(e.response).response,i=n.nickName,o=n.avatar;r({nickName:i,avatarUrl:o})}catch(e){}},fail:function(){t.logger.info("getUserInfo fail"),r()}})):(t.logger.info("getSetting scope.userInfo fail"),r())},fail:function(){t.logger.info("getSetting fail"),r()}})}}},{key:"verify",value:function(){var e=this;this.sdk._once("app-show",(function(){var t=e.which;try{if(void 0!==t.getLaunchOptionsSync){var n=t.getLaunchOptionsSync().query;e.verifyDo(n)}}catch(e){}}))}}]),a}(),le=function(e){o(r,M);var n=c(r);function r(){var e;return t(this,r),(e=n.apply(this,arguments)).currentPath="",e.titleCaches={},e}return i(r,[{key:"apply",value:function(){var e=this;this.which=this.getWhich(),this.sdk._getRouteInfo=this.getRouteInfo.bind(this),this.sdk._getPageTitle=this.getPageTitle.bind(this),this.sdk._on("instantiation",(function(t){e.proxySetTitle(),e.onPageChange()}))}},{key:"getWhich",value:function(){return{}}},{key:"proxySetTitle",value:function(){var e=this.which,t=this.titleCaches;try{var n=function(e){return function(){return function(n){try{var i=getCurrentPages(),r=i[i.length-1].route||"";O(n)||(n={}),t[r]=n.title}catch(e){}e.call(this,n)}}};if(void 0!==e.setNavigationBarTitle){var i=e.setNavigationBarTitle;Object.defineProperty(e,"setNavigationBarTitle",{get:n(i)})}else if(void 0!==e.setNavigationBar){var r=e.setNavigationBar;Object.defineProperty(e,"setNavigationBar",{get:n(r)})}}catch(e){}}},{key:"getRouteInfo",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:1,t=arguments.length>1?arguments[1]:void 0;try{var n=(t=t||getCurrentPages()).length-e;if(n<0)return null;var i=t[n],r=i.route,o=void 0===r?"":r,a=i.options,s=void 0===a?{}:a;return{path:o,query:s}}catch(e){}return null}},{key:"onPageChange",value:function(){var e=this;this.sdk._on("page-show",(function(t){e.getPageUrl()}))}},{key:"getPageUrl",value:function(){try{var e=this.getRouteInfo();if(!e)return;var t=e.path,n=e.query;this.currentPath=t,this.sdk._mergeEnv({evtParams:{$current_path:t,$current_query:n?JSON.stringify(n):void 0}})}catch(e){}}},{key:"getEnvConfig",value:function(){return null}},{key:"getPageTitle",value:function(e){var t="";if(void 0!==this.titleCaches[e]&&(t=this.titleCaches[e]),!t)try{var n=this.getEnvConfig();if(n){var i=n.page[e]||n.page[e+".html"];i&&(t=i.window.navigationBarTitleText),t||(t=n.global.window.navigationBarTitleText)}}catch(e){}return t}}]),r}(),de=(void 0,function(e,t){var n={};for(var i in e)Object.prototype.hasOwnProperty.call(e,i)&&t.indexOf(i)<0&&(n[i]=e[i]);if(null!=e&&"function"==typeof Object.getOwnPropertySymbols){var r=0;for(i=Object.getOwnPropertySymbols(e);r<i.length;r++)t.indexOf(i[r])<0&&Object.prototype.propertyIsEnumerable.call(e,i[r])&&(n[i[r]]=e[i[r]])}return n});!function(e){e[e.Update=1]="Update",e[e.Replace=2]="Replace"}(he||(he={}));var _e=function(e){o(r,M);var n=c(r);function r(){var e;return t(this,r),(e=n.apply(this,arguments)).fetchTokenComplete=!1,e.tempWebId="",e.tempUserUniqueId=void 0,e}return i(r,[{key:"apply",value:function(){var e=this;this.sdk._on("custom-process",(function(t){e.onConfig(),t._once("fetch-token-complete",(function(t,n){n&&t._emit("token-ok"),e.fetchTokenComplete=!0})),e.fetchCacheToken((function(e){t._emit("fetch-token-complete",e)}))}))}},{key:"onConfig",value:function(){var e=this;this.sdk._on("config",(function(t,n){var i=n.web_id,r=n.user_unique_id,o=de(n,["web_id","user_unique_id"]);t._mergeEnv(o);var a=t._envInfo.user,s={};void 0!==i&&i&&e._checkWebId(i)&&(i="".concat(i),e.fetchTokenComplete?t._tokenOK?a.web_id!==i&&(s.web_id=i,a.web_id===a.user_unique_id&&(s.user_unique_id=i,a.user_unique_id=i),a.web_id=i):(s.web_id=i,a.web_id=i,a.user_unique_id?s.user_unique_id=a.user_unique_id:(s.user_unique_id=i,a.user_unique_id=i),t._emit("token-ok")):e.tempWebId=i),void 0!==r&&(r="".concat(r),e.fetchTokenComplete?t._tokenOK?r!==a.user_unique_id&&(t._emit("fetch-ssid-complete-hook"),r?(s.user_unique_id=r,a.user_unique_id=r):(s.user_unique_id=a.web_id,a.user_unique_id=a.web_id),t._emit("fetch-ssid-complete-done")):a.user_unique_id=r||null:e.tempUserUniqueId=r),Object.keys(s).length>0&&e._updateStorageToken(s)}))}},{key:"fetchCacheToken",value:function(e){var t=this.sdk.storage,n=this.getKey(),i=t.get(n);if(i)return this._hasCacheToken(e,i),void 0;e(!1)}},{key:"_hasCacheToken",value:function(e,t){var n=t.web_id,i=t.user_unique_id;t.ssid&&(this._updateStorageToken({},he.Replace),n=void 0,i=void 0);var r=this.sdk._envInfo.user,o=function(t,n){r.web_id=t,r.user_unique_id=n,e(!0)};if(n){if(!this.tempWebId||this.tempWebId===n){if(void 0===this.tempUserUniqueId)return o(n,i),void 0;return i=this.tempUserUniqueId?this.tempUserUniqueId:n,this.tempUserUniqueId=void 0,this._updateStorageToken({web_id:n,user_unique_id:i},he.Replace),o(n,i),void 0}}else if(!this.tempWebId)return e(!1),void 0;n=this.tempWebId,void 0!==this.tempUserUniqueId?(i=this.tempUserUniqueId?this.tempUserUniqueId:n,this.tempUserUniqueId=void 0):i||(i=n),this.tempWebId=void 0,this._updateStorageToken({web_id:n,user_unique_id:i},he.Replace),o(n,i)}},{key:"_updateStorageToken",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:he.Update,n=this.sdk.storage,i=this.getKey(),r=n.get(i),o=t===he.Update?Object.assign(Object.assign({},r||{}),e||{}):Object.assign({},e||{});n.set(i,o)}},{key:"_checkWebId",value:function(e){if("number"==typeof e)return!0;if("string"==typeof e&&/^\d+$/.test(e))return!0;return!1}},{key:"getKey",value:function(){var e=this.sdk,t=e.appId,n=e._keyPrefix;return"".concat(n,"tokens_").concat(t)}}]),r}(),ve="undefined",ye={wx:[0,"miniProduct"],my:[1,"aliMiniProduct"],tt:[2,"ttMiniProduct"],swan:[5,"swanMiniProduct"],qq:[6,"qqMiniProduct"],uni:[7,"uniMiniProduct"]},ge=function(){return("undefined"==typeof wx?"undefined":e(wx))!==ve},me=function(){return("undefined"==typeof my?"undefined":e(my))!==ve},ke=function(){return("undefined"==typeof tt?"undefined":e(tt))!==ve},be=function(){return("undefined"==typeof swan?"undefined":e(swan))!==ve},Oe=function(){return("undefined"==typeof qq?"undefined":e(qq))!==ve},we=function(){return("undefined"==typeof tt?"undefined":e(tt))!==ve?tt:("undefined"==typeof my?"undefined":e(my))!==ve?my:("undefined"==typeof swan?"undefined":e(swan))!==ve?swan:("undefined"==typeof qq?"undefined":e(qq))!==ve?qq:("undefined"==typeof wx?"undefined":e(wx))!==ve?wx:("undefined"==typeof uni?"undefined":e(uni))!==ve?uni:{}},xe=S,Ee=j,Se=function(n){o(a,M);var r=c(a);function a(){return t(this,a),r.apply(this,arguments)}return i(a,[{key:"apply",value:function(){var e=this;this.sdk._on(Ee.Device,(function(t){t._mergeEnv({sdk_lib:"mp_common"}),e.getInfo()})),this.sdk._on(Ee.AppShow,(function(t){e.getInfo()})),this.sdk._on(Ee.Init,(function(t){e.sdk._emit(Ee.ReportOption,{dataType:"json",header:Object.assign({},xe)})}))}},{key:"getInfo",value:function(){var t=this.sdk,n=we(),i=("undefined"==typeof tt?"undefined":e(tt))!==ve?ye.tt:("undefined"==typeof my?"undefined":e(my))!==ve?ye.my:("undefined"==typeof swan?"undefined":e(swan))!==ve?ye.swan:("undefined"==typeof qq?"undefined":e(qq))!==ve?ye.qq:("undefined"==typeof wx?"undefined":e(wx))!==ve?ye.wx:("undefined"==typeof uni?"undefined":e(uni))!==ve?ye.uni:[];t._mergeEnv({mp_platform:i[0],custom_platform:i[1]}),n&&(n.getSystemInfo&&n.getSystemInfo({success:function(r){var o={device_brand:r.brand,device_model:r.model,os_version:r.system,os_name:r.platform,platform:r.platform,custom_platform:i[1],resolution:"".concat(r.screenWidth,"x").concat(r.screenHeight),screen_width:r.screenWidth,screen_height:r.screenHeight};("undefined"==typeof wx?"undefined":e(wx))===ve&&("undefined"==typeof my?"undefined":e(my))===ve&&("undefined"==typeof swan?"undefined":e(swan))===ve&&("undefined"==typeof qq?"undefined":e(qq))===ve&&("undefined"==typeof uni?"undefined":e(uni))===ve||(o=Object.assign(Object.assign({},o),{language:r.language})),t._mergeEnv(o);var a={mp_platform:i[0],mp_platform_app_version:r.version,mp_platform_basic_version:("undefined"==typeof my?"undefined":e(my))!==ve?n.SDKVersion:r.SDKVersion};t._mergeEnv(a)}}),n.getNetworkType&&n.getNetworkType({success:function(e){var n={access:e.networkType};t._mergeEnv(n)}}))}}]),a}();var je,Ie={mpLaunch:"mp_launch",mpEnter:"mp_enter",mpExit:"mp_exit",purchase:"purchase",query:"query",updateLevel:"update_level",createGameRole:"create_gamerole",checkout:"check_out",addToFavourite:"add_to_favourite"},Pe=Object.freeze({__proto__:null,Events:Ie,mpLaunch:function(e,t){e(Ie.mpLaunch,Object.assign({},t))},mpEnter:function(e,t){je=+new Date,e(Ie.mpEnter,Object.assign({},t))},mpExit:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},n=getCurrentPages(),i=n[n.length-1].route,r=void 0===je?0:+new Date-je;e(Ie.mpExit,Object.assign({duration:r,page_path:i},t)),je=void 0},purchase:function(e,t){e(Ie.purchase,Object.assign({},t))},quest:function(e,t){e(Ie.query,Object.assign({},t))},updateLevel:function(e,t){e(Ie.updateLevel,Object.assign({},t))},createGameRole:function(e,t){e(Ie.createGameRole,Object.assign({},t))},checkout:function(e,t){e(Ie.checkout,Object.assign({},t))},addToFavourite:function(e,t){e(Ie.addToFavourite,Object.assign({},t))}}),qe=j,Ae=function(e){o(r,M);var n=c(r);function r(){return t(this,r),n.apply(this,arguments)}return i(r,[{key:"apply",value:function(){this.sdk._on(qe.Instantiation,(function(e){var t=Ie,n=function(e,t){var n={};for(var i in e)Object.prototype.hasOwnProperty.call(e,i)&&t.indexOf(i)<0&&(n[i]=e[i]);if(null!=e&&"function"==typeof Object.getOwnPropertySymbols){var r=0;for(i=Object.getOwnPropertySymbols(e);r<i.length;r++)t.indexOf(i[r])<0&&Object.prototype.propertyIsEnumerable.call(e,i[r])&&(n[i[r]]=e[i[r]])}return n}(Pe,["Events"]),i=e._getExtraData("white-events");e._setExtraData("white-events",[].concat(l(i||[]),l(Object.values(t)))),Object.keys(n).forEach((function(t){e[t]=n[t].bind(null,e.event.bind(e))}))}))}}]),r}(),Te=function(n){o(s,pe);var r=c(s);function s(){return t(this,s),r.apply(this,arguments)}return i(s,[{key:"getWhich",value:function(){return we()}},{key:"proxyAppDo",value:function(){var t=this.sdk,n=this.appHacks;if(("undefined"==typeof swan?"undefined":e(swan))!==ve&&"function"==typeof App.after)App.after({methods:Object.assign({},n)}),App.after({methods:{onLaunch:function(e){t._emit("swan-launch",e)}}});else{var i=h(a(s.prototype),"proxyAppDo",this).call(this);("undefined"==typeof swan?"undefined":e(swan))!==ve&&Object.keys(i).forEach((function(e){App[e]=i[e]}))}}},{key:"proxyPageSdkMethodsExtend",value:function(){}},{key:"proxyPageDo",value:function(){var t=this.pageHacks;if(("undefined"==typeof swan?"undefined":e(swan))!==ve&&"function"==typeof Page.after)Page.after({methods:Object.assign({},t)});else{var n=h(a(s.prototype),"proxyPageDo",this).call(this);("undefined"==typeof swan?"undefined":e(swan))!==ve&&Object.keys(n).forEach((function(e){Page[e]=n[e]}))}}},{key:"proxyComponent",value:function(){if(("undefined"==typeof my?"undefined":e(my))!==ve&&!my.canIUse("component2"))return;h(a(s.prototype),"proxyComponent",this).call(this)}},{key:"verify",value:function(){var t=this,n=this.sdk;if(("undefined"==typeof swan?"undefined":e(swan))!==ve){var i=!1;n._on("swan-launch",(function(e,n){if(i)return;i=!0;try{var r=n.query;t.verifyDo(r)}catch(e){}}))}else h(a(s.prototype),"verify",this).call(this)}}]),s}(),Ce=j,De=function(e){o(r,M);var n=c(r);function r(){return t(this,r),n.apply(this,arguments)}return i(r,[{key:"apply",value:function(){var e=this;this.sdk._on(Ce.Instantiation,(function(){e.sdk._mergeEnv({sdk_version:"1.11.1",_sdk_version:"1.11.1",_sdk_name:"@datarangers/sdk-mp".replace("@dp/tea-","")||"sdk-common"})}))}}]),r}(),Ue=function(e){o(r,le);var n=c(r);function r(){return t(this,r),n.apply(this,arguments)}return i(r,[{key:"getWhich",value:function(){return we()}},{key:"getEnvConfig",value:function(){try{if(ke())return __ttConfig;if(ge())return __wxConfig;if(Oe())return __qqConfig;if(me())return null;if(be())return null}catch(e){}return null}}]),r}();re.use(Se,{type:"plugin"}),re.use(Ae,{type:"plugin"}),re.use((function(n,r){return function(n){return function(){function n(){t(this,n)}return i(n,[{key:"get",value:function(t){var n=arguments.length>1&&void 0!==arguments[1]&&arguments[1],i=we();try{if(("undefined"==typeof wx?"undefined":e(wx))!==ve||("undefined"==typeof tt?"undefined":e(tt))!==ve||("undefined"==typeof swan?"undefined":e(swan))!==ve||("undefined"==typeof qq?"undefined":e(qq))!==ve||("undefined"==typeof uni?"undefined":e(uni))!==ve){var r=i.getStorageInfoSync();if(r&&r.keys&&r.keys.includes(t))return i.getStorageSync(t)}else if(("undefined"==typeof my?"undefined":e(my))!==ve){var o=i.getStorageSync({key:t});return o.data}}catch(e){n&&this.remove(t)}return null}},{key:"set",value:function(t,n){var i=arguments.length>2&&void 0!==arguments[2]&&arguments[2],r=we(),o=function(){("undefined"==typeof wx?"undefined":e(wx))!==ve||("undefined"==typeof tt?"undefined":e(tt))!==ve||("undefined"==typeof swan?"undefined":e(swan))!==ve||("undefined"==typeof qq?"undefined":e(qq))!==ve||("undefined"==typeof uni?"undefined":e(uni))!==ve?r.setStorageSync(t,n):("undefined"==typeof my?"undefined":e(my))!==ve&&r.setStorageSync({key:t,data:n})};try{return o(),!0}catch(e){if(i)this.remove(t);else if(t.includes("_reports_")||t.includes("_events_")){this.remove(t);try{return o(),!0}catch(e){}}}return!1}},{key:"remove",value:function(t){var n=we();try{("undefined"==typeof wx?"undefined":e(wx))!==ve||("undefined"==typeof tt?"undefined":e(tt))!==ve||("undefined"==typeof swan?"undefined":e(swan))!==ve||("undefined"==typeof qq?"undefined":e(qq))!==ve||("undefined"==typeof uni?"undefined":e(uni))!==ve?n.removeStorageSync(t):("undefined"==typeof my?"undefined":e(my))!==ve&&n.removeStorageSync({key:t})}catch(e){}}}]),n}()}}),{name:"storage",type:"adapter"}),re.use((function(t,n){return function(t){return function(n){var i={},r=n.timeout||t._options.request_timeout,o=r&&-1!==r&&"number"==typeof r;o&&("undefined"==typeof tt?"undefined":e(tt))===ve&&("undefined"==typeof swan?"undefined":e(swan))===ve&&(i[r]=r),i=Object.assign(Object.assign({},n),{dataType:n.dataType||"json"});var a=we(),s=("undefined"==typeof my?"undefined":e(my))!==ve?a[a.request?"request":"httpRequest"](i):a.request(i);return o&&(("undefined"==typeof tt?"undefined":e(tt))!==ve&&("undefined"==typeof swan?"undefined":e(swan))!==ve||setTimeout((function(){try{s&&s.abort()}catch(e){}}),r)),s}}}),{name:"request",type:"adapter"}),re.use((function(n,r){return function(n){return function(n){o(a,v);var r=c(a);function a(){return t(this,a),r.call(this,("undefined"==typeof console?"undefined":e(console))!==ve?console:{info:function(){},warn:function(){},error:function(){}})}return i(a)}()}}),{name:"logger",type:"adapter"}),re.use(De,{type:"plugin"}),re.use(ce,{type:"plugin"}),re.use(Te,{type:"plugin"}),re.use(Ue,{type:"plugin"}),re.use(_e,{type:"plugin"});var Ne=new re;module.exports=Ne;